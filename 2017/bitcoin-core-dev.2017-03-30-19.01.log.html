<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<title>#bitcoin-core-dev log</title>
<style type="text/css">
/* For the .log.html */
pre { /*line-height: 125%;*/
      white-space: pre-wrap; }
body { background: #f0f0f0; }

body .tm  { color: #007020 }                      /* time */
body .nk  { color: #062873; font-weight: bold }   /* nick, regular */
body .nka { color: #007020; font-weight: bold }  /* action nick */
body .ac  { color: #00A000 }                      /* action line */
body .hi  { color: #4070a0 }                 /* hilights */
/* Things to make particular MeetBot commands stick out */
body .topic     { color: #007020; font-weight: bold }
body .topicline { color: #000080; font-weight: bold }
body .cmd       { color: #007020; font-weight: bold }
body .cmdline  { font-weight: bold }

</style>
</head>

<body>
<pre><a name="l-1"></a><span class="tm">19:01:18</span><span class="nk"> &lt;wumpus&gt;</span> <span class="cmd">#startmeeting</span><span class="cmdline"></span>
<a name="l-2"></a><span class="tm">19:01:18</span><span class="nk"> &lt;lightningbot&gt;</span> Meeting started Thu Mar 30 19:01:18 2017 UTC.  The chair is wumpus. Information about MeetBot at http://wiki.debian.org/MeetBot.
<a name="l-3"></a><span class="tm">19:01:18</span><span class="nk"> &lt;lightningbot&gt;</span> Useful Commands: #action #agreed #help #info #idea #link #topic.
<a name="l-4"></a><span class="tm">19:01:41</span><span class="nk"> &lt;instagibbs&gt;</span> hi
<a name="l-5"></a><span class="tm">19:01:46</span><span class="nk"> &lt;jeremyrubin&gt;</span> here
<a name="l-6"></a><span class="tm">19:01:56</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">BlueMatt:</span> it shouldn't matter for the AbortNode() case though. Just make the conditional wait 200 milliseconds or so
<a name="l-7"></a><span class="tm">19:02:03</span><span class="nk"> &lt;jtimon&gt;</span> topics?
<a name="l-8"></a><span class="tm">19:02:24</span><span class="nk"> &lt;wumpus&gt;</span> doesn't matter if signals are slightly delayed
<a name="l-9"></a><span class="tm">19:02:30</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">wumpus:</span> the wait is already 200ms
<a name="l-10"></a><span class="tm">19:02:30</span><span class="nk"> &lt;wumpus&gt;</span> yes, topics?
<a name="l-11"></a><span class="tm">19:02:34</span><span class="nk"> &lt;BlueMatt&gt;</span> talk about abortnode
<a name="l-12"></a><span class="tm">19:02:36</span><span class="nk"> &lt;BlueMatt&gt;</span> thats a reasonable topic
<a name="l-13"></a><span class="tm">19:02:38</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">BlueMatt:</span> yes, but make it a wait on a conditional
<a name="l-14"></a><span class="tm">19:02:44</span><span class="nk"> &lt;BlueMatt&gt;</span> mmm, fair
<a name="l-15"></a><span class="tm">19:02:56</span><span class="nk"> &lt;BlueMatt&gt;</span> yes, for sigterm its reasonable to wait a few 100 ms
<a name="l-16"></a><span class="tm">19:03:03</span><span class="nk"> &lt;BlueMatt&gt;</span> for AbortNode it'll wake it immediately
<a name="l-17"></a><span class="tm">19:03:06</span><span class="nk"> &lt;wumpus&gt;</span> right.
<a name="l-18"></a><span class="tm">19:04:15</span><span class="nk"> &lt;BlueMatt&gt;</span> in other news, so we got 1/6 "Review Priority" PRs merged this week, that's ok, but we can do better :)
<a name="l-19"></a><span class="tm">19:04:45</span><span class="nk"> &lt;BlueMatt&gt;</span> oh, nvm, got 2/6
<a name="l-20"></a><span class="tm">19:04:49</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">FYI:</span> https://github.com/bitcoin/bitcoin/projects/8
<a name="l-21"></a><span class="tm">19:05:26</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">BlueMatt:</span> 2/6.
<a name="l-22"></a><span class="tm">19:05:28</span><span class="nk"> &lt;wumpus&gt;</span> removed the two that have been merged
<a name="l-23"></a><span class="tm">19:05:28</span><span class="nk"> &lt;jtimon&gt;</span> I don't think anyone commented in mine, at least I got review in others
<a name="l-24"></a><span class="tm">19:05:49</span><span class="nk"> &lt;gmaxwell&gt;</span> I forgot about the project tracker thing, but reviewed some of them anyways.
<a name="l-25"></a><span class="tm">19:06:32</span><span class="nk"> &lt;wumpus&gt;</span> doesn't matter, we'll only add pulls that were mentioned to have priority in the meeting to that project tracker, so if you pay attention at the meeting you don't need it :)
<a name="l-26"></a><span class="tm">19:07:31</span><span class="nk"> &lt;wumpus&gt;</span> anyhow, everyone go review them
<a name="l-27"></a><span class="tm">19:08:21</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">topic:</span> 0.14.1?
<a name="l-28"></a><span class="tm">19:08:29</span><span class="nk"> &lt;bitcoin-git&gt;</span> [13bitcoin] 15sipa opened pull request #10126: Compensate for memory peak at flush time (06master...06peak_compensation) 02https://github.com/bitcoin/bitcoin/pull/10126
<a name="l-29"></a><span class="tm">19:08:29</span><span class="nk"> &lt;gmaxwell&gt;</span> Yes, please.
<a name="l-30"></a><span class="tm">19:08:33</span><span class="nk"> &lt;jeremyrubin&gt;</span> <span class="hi">topic:</span> slow tests?
<a name="l-31"></a><span class="tm">19:08:37</span><span class="nk"> &lt;wumpus&gt;</span> <span class="topic">#topic </span><span class="topicline">0.14.1</span>
<a name="l-32"></a><span class="tm">19:09:02</span><span class="nk"> &lt;achow101&gt;</span> already?
<a name="l-33"></a><span class="tm">19:09:25</span><span class="nk"> &lt;gmaxwell&gt;</span> yes. lots of nice fixes to ship. Minor releases are minor.
<a name="l-34"></a><span class="tm">19:09:39</span><span class="nk"> &lt;sipa&gt;</span> we have 11 merged PRs marked 0.14.1
<a name="l-35"></a><span class="tm">19:09:59</span><span class="nk"> &lt;wumpus&gt;</span> and three open pulls https://github.com/bitcoin/bitcoin/pulls?q=is%3Aopen+is%3Apr+milestone%3A0.14.1
<a name="l-36"></a><span class="tm">19:10:32</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">sipa:</span> only one still has the "needs backport" tag, I think MarcoFalke ported the rest
<a name="l-37"></a><span class="tm">19:10:44</span><span class="nk"> &lt;gmaxwell&gt;</span> I think when we get those three in and those and the recent ones backported, we should be goof for a 0.14.1.
<a name="l-38"></a><span class="tm">19:11:11</span><span class="nk"> &lt;gmaxwell&gt;</span> good too.
<a name="l-39"></a><span class="tm">19:11:41</span><span class="nk"> &lt;wumpus&gt;</span> agreed
<a name="l-40"></a><span class="tm">19:12:45</span><span class="nk"> &lt;wumpus&gt;</span> ok, next topic I guess
<a name="l-41"></a><span class="tm">19:12:48</span><span class="nk"> &lt;wumpus&gt;</span> <span class="topic">#topic </span><span class="topicline">slow tests</span>
<a name="l-42"></a><span class="tm">19:13:11</span><span class="nk"> &lt;wumpus&gt;</span> I made an overview here: https://github.com/bitcoin/bitcoin/issues/10026  of the slowest unit tests
<a name="l-43"></a><span class="tm">19:13:15</span><span class="nk"> &lt;jeremyrubin&gt;</span> A lot of it is my fault it seems. https://github.com/bitcoin/bitcoin/pull/10099 is ready to go
<a name="l-44"></a><span class="tm">19:13:27</span><span class="nk"> &lt;wumpus&gt;</span> some of those have already been worked on or even PRs open to make them faster
<a name="l-45"></a><span class="tm">19:13:36</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">jnewbery:</span> if you're around, if 10106 doesn't move forward in a few hours, I recommend you create a new pr, cherry picking that one fix, with your new tests and the fix for the other function.  (just because the PR wasn't opened by a regular so they may not be responsive or may not know how to use github well enough to pull your changes.)
<a name="l-46"></a><span class="tm">19:14:12</span><span class="nk"> &lt;jnewbery&gt;</span> <span class="hi">gmaxwell:</span> I'll do that this afternoon
<a name="l-47"></a><span class="tm">19:14:43</span><span class="nk"> &lt;wumpus&gt;</span> yes, tend to agree, they may not know how to cherry-pick them. I could cherry-pick them into his branch but meh
<a name="l-48"></a><span class="tm">19:14:53</span><span class="nk"> &lt;MarcoFalke_lab&gt;</span> <span class="hi">wumpus:</span> Yes, dropping GetRand() gave a 4* speedup.
<a name="l-49"></a><span class="tm">19:15:02</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">jnewbery:</span> and thanks for the awesome response.
<a name="l-50"></a><span class="tm">19:15:08</span><span class="nk"> &lt;jnewbery&gt;</span> np
<a name="l-51"></a><span class="tm">19:15:37</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">MarcoFalke_lab:</span> that'll at least move it down a bit in the top 20
<a name="l-52"></a><span class="tm">19:15:42</span><span class="nk"> &lt;jeremyrubin&gt;</span> The cuckoocache tests require a bit more discussion to decrease the parameters; I can pick something arbitrary
<a name="l-53"></a><span class="tm">19:16:27</span><span class="nk"> &lt;jeremyrubin&gt;</span> The checkqueue tests should also speed up a lot with #9938, but I'm preparing some tweaks to those
<a name="l-54"></a><span class="tm">19:16:28</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/9938 | Lock-Free CheckQueue by JeremyRubin Â· Pull Request #9938 Â· bitcoin/bitcoin Â· GitHub
<a name="l-55"></a><span class="tm">19:16:46</span><span class="nk"> &lt;Chris_Stewart_5&gt;</span> re tests: Has anyone given any thought to #8469 , obviously this pull request sacrafices speed for exhaustiveness
<a name="l-56"></a><span class="tm">19:16:48</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/8469 | [POC] Introducing property based testing to Core by Christewart Â· Pull Request #8469 Â· bitcoin/bitcoin Â· GitHub
<a name="l-57"></a><span class="tm">19:17:02</span><span class="nk"> &lt;jeremyrubin&gt;</span> If anyone has high-core machines, they should try benching how that works
<a name="l-58"></a><span class="tm">19:17:02</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">jeremyrubin:</span> alternatively we could have an -extended mode for the unit tests, like we have for the functional tests, to do extra-thorough tests that shouldn't run every time
<a name="l-59"></a><span class="tm">19:17:13</span><span class="nk"> &lt;MarcoFalke_lab&gt;</span> <span class="hi">jeremyrubin:</span> If the parameters matter, you could provide a switch to test against quick_run and an expensive one
<a name="l-60"></a><span class="tm">19:17:20</span><span class="nk"> &lt;wumpus&gt;</span> yes ^^
<a name="l-61"></a><span class="tm">19:17:27</span><span class="nk"> &lt;gmaxwell&gt;</span> I think we should have an extended test, and make running it part of the release process.
<a name="l-62"></a><span class="tm">19:17:42</span><span class="nk"> &lt;jeremyrubin&gt;</span> Agree
<a name="l-63"></a><span class="tm">19:17:45</span><span class="nk"> &lt;wumpus&gt;</span> but for the standard 'make check' there should be a guideline of max ~1 second per test case
<a name="l-64"></a><span class="tm">19:17:59</span><span class="nk"> &lt;MarcoFalke_lab&gt;</span> Everyone agrees! :)
<a name="l-65"></a><span class="tm">19:18:07</span><span class="nk"> &lt;gmaxwell&gt;</span> I don't care if the tests take an hour to run if it's only a mandatory once in release thing.
<a name="l-66"></a><span class="tm">19:18:09</span><span class="nk"> &lt;cfields&gt;</span> sgtm
<a name="l-67"></a><span class="tm">19:18:11</span><span class="nk"> &lt;jeremyrubin&gt;</span> no, 2 seconds!
<a name="l-68"></a><span class="tm">19:18:18</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> yes or once per day or so on master
<a name="l-69"></a><span class="tm">19:18:35</span><span class="nk"> &lt;jonasschnelli&gt;</span> (which is failing currently)
<a name="l-70"></a><span class="tm">19:18:49</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">jonasschnelli:</span> what is failing?
<a name="l-71"></a><span class="tm">19:18:49</span><span class="nk"> &lt;wumpus&gt;</span> yes, travis is broken again, but there's a pull to fix that
<a name="l-72"></a><span class="tm">19:18:52</span><span class="nk"> &lt;cfields&gt;</span> note to self: gitian should run whatever extended tests it can
<a name="l-73"></a><span class="tm">19:18:55</span><span class="nk"> &lt;gmaxwell&gt;</span> oh travis
<a name="l-74"></a><span class="tm">19:18:58</span><span class="nk"> &lt;jonasschnelli&gt;</span> <span class="hi">gmaxwell:</span> https://travis-ci.org/bitcoin/bitcoin/builds
<a name="l-75"></a><span class="tm">19:19:13</span><span class="nk"> &lt;MarcoFalke_lab&gt;</span> Jup, will merge the travis fix tonight when I have access to my keys. (If no one beats me to it)
<a name="l-76"></a><span class="tm">19:19:31</span><span class="nk"> &lt;wumpus&gt;</span> does anyone have the # perhaps?
<a name="l-77"></a><span class="tm">19:19:58</span><span class="nk"> &lt;sdaftuar&gt;</span> i think #10114?
<a name="l-78"></a><span class="tm">19:19:59</span><span class="nk"> &lt;MarcoFalke_lab&gt;</span> Though, we should be cautious with putting too much into the cron jobs. The extended test rely on the cache being up to date
<a name="l-79"></a><span class="tm">19:19:59</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/10114 | An error has occurred and has been logged. Please contact this bot's administrator for more information.
<a name="l-80"></a><span class="tm">19:20:10</span><span class="nk"> &lt;MarcoFalke_lab&gt;</span> Otherwise they would break the 49 minute limit on traivs
<a name="l-81"></a><span class="tm">19:20:11</span><span class="nk"> &lt;wumpus&gt;</span> there's also #10072
<a name="l-82"></a><span class="tm">19:20:12</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/10072 | Remove sources of unreliablility in extended functional tests by jnewbery Â· Pull Request #10072 Â· bitcoin/bitcoin Â· GitHub
<a name="l-83"></a><span class="tm">19:20:39</span><span class="nk"> &lt;wumpus&gt;</span> but yes 114 was the one I meant
<a name="l-84"></a><span class="tm">19:20:40</span><span class="nk"> &lt;gmaxwell&gt;</span> We should probably contemplate having some seperate process against master that does continual gitian builds or something.
<a name="l-85"></a><span class="tm">19:21:10</span><span class="nk"> &lt;MarcoFalke_lab&gt;</span> <span class="hi">jonasschnelli:</span> Is doing that, gmaxwell
<a name="l-86"></a><span class="tm">19:21:22</span><span class="nk"> &lt;gmaxwell&gt;</span> oh good.
<a name="l-87"></a><span class="tm">19:21:25</span><span class="nk"> &lt;gmaxwell&gt;</span> ignore me.
<a name="l-88"></a><span class="tm">19:21:29</span><span class="nk"> &lt;jonasschnelli&gt;</span> <span class="hi">gmaxwell:</span> https://bitcoin.jonasschnelli.ch
<a name="l-89"></a><span class="tm">19:21:32</span><span class="nk"> &lt;wumpus&gt;</span> yes, jonasschnelli has a build server with a very nice web UI
<a name="l-90"></a><span class="tm">19:21:43</span><span class="nk"> &lt;MarcoFalke_lab&gt;</span> <span class="hi">jonasschnelli:</span> Are you running the tests?
<a name="l-91"></a><span class="tm">19:21:44</span><span class="nk"> &lt;jonasschnelli&gt;</span> (it's currently by manual trigger)
<a name="l-92"></a><span class="tm">19:21:50</span><span class="nk"> &lt;jonasschnelli&gt;</span> no.. just gitian
<a name="l-93"></a><span class="tm">19:21:55</span><span class="nk"> &lt;gmaxwell&gt;</span> somehow I missed this. cool.
<a name="l-94"></a><span class="tm">19:22:08</span><span class="nk"> &lt;wumpus&gt;</span> travis already runs the tests, this is to get executables for testing
<a name="l-95"></a><span class="tm">19:23:31</span><span class="nk"> &lt;jnewbery&gt;</span> travis is only broken now because we've set it to run the extended tests once per day, so we're currently flushing out all the extended tests that have always failed on travis. I think once #10114 and #10072 are merged the daily runs should succeed reliably
<a name="l-96"></a><span class="tm">19:23:32</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/10114 | An error has occurred and has been logged. Please contact this bot's administrator for more information.
<a name="l-97"></a><span class="tm">19:23:33</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/10072 | Remove sources of unreliablility in extended functional tests by jnewbery Â· Pull Request #10072 Â· bitcoin/bitcoin Â· GitHub
<a name="l-98"></a><span class="tm">19:24:08</span><span class="nk"> &lt;jonasschnelli&gt;</span> thanks jnewbery for the info (and the fixes)
<a name="l-99"></a><span class="tm">19:25:56</span><span class="nk"> &lt;bitcoin-git&gt;</span> [13bitcoin] 15sdaftuar opened pull request #10127: [0.14 backport] Mining: Prevent slowdown in CreateNewBlock on large mempools  (060.14...062017-03-backport-cnb-optimizations) 02https://github.com/bitcoin/bitcoin/pull/10127
<a name="l-100"></a><span class="tm">19:26:48</span><span class="nk"> &lt;wumpus&gt;</span> ok, any other topics?
<a name="l-101"></a><span class="tm">19:27:41</span><span class="nk"> &lt;bitcoin-git&gt;</span> [13bitcoin] 15laanwj pushed 3 new commits to 06master: 02https://github.com/bitcoin/bitcoin/compare/cde9b1a864c1...edc62c959ab3
<a name="l-102"></a><span class="tm">19:27:42</span><span class="nk"> &lt;bitcoin-git&gt;</span> 13bitcoin/06master 146426716 15John Newbery: Add send_await_disconnect() method to p2p-compactblocks.py...
<a name="l-103"></a><span class="tm">19:27:42</span><span class="nk"> &lt;bitcoin-git&gt;</span> 13bitcoin/06master 146a18bb9 15John Newbery: [tests] sync_with_ping should assert that ping hasn't timed out...
<a name="l-104"></a><span class="tm">19:27:43</span><span class="nk"> &lt;bitcoin-git&gt;</span> 13bitcoin/06master 14edc62c9 15Wladimir J. van der Laan: Merge #10114: [tests] sync_with_ping should assert that ping hasn't timed out...
<a name="l-105"></a><span class="tm">19:27:49</span><span class="nk"> &lt;gmaxwell&gt;</span> I should make notes for topics...
<a name="l-106"></a><span class="tm">19:27:57</span><span class="nk"> &lt;BlueMatt&gt;</span> oh, new prs
<a name="l-107"></a><span class="tm">19:28:02</span><span class="nk"> &lt;BlueMatt&gt;</span> for review priority
<a name="l-108"></a><span class="tm">19:28:12</span><span class="nk"> &lt;BlueMatt&gt;</span> looks like jonasschnelli already added his
<a name="l-109"></a><span class="tm">19:28:16</span><span class="nk"> &lt;bitcoin-git&gt;</span> [13bitcoin] 15laanwj closed pull request #10114: [tests] sync_with_ping should assert that ping hasn't timed out (06master...06improve_sync_with_ping) 02https://github.com/bitcoin/bitcoin/pull/10114
<a name="l-110"></a><span class="tm">19:28:21</span><span class="nk"> &lt;BlueMatt&gt;</span> anyone else have something to add (aside from 0.14.1-tagged things)
<a name="l-111"></a><span class="tm">19:28:22</span><span class="nk"> &lt;wumpus&gt;</span> fine with me, but don't forget the current bunch :p
<a name="l-112"></a><span class="tm">19:28:32</span><span class="nk"> &lt;wumpus&gt;</span> yes please review 0.14.1 tagged things
<a name="l-113"></a><span class="tm">19:28:35</span><span class="nk"> &lt;wumpus&gt;</span> although those should be easy
<a name="l-114"></a><span class="tm">19:28:36</span><span class="nk"> &lt;jonasschnelli&gt;</span> <span class="hi">BlueMatt:</span> Yes. The bumpfee refactor (to get a QT fee bump function)
<a name="l-115"></a><span class="tm">19:28:53</span><span class="nk"> &lt;sipa&gt;</span> 0.14.1 has priority, but i'd like to see #9792 in at some point to further the get-rid-of-openssl thing :)
<a name="l-116"></a><span class="tm">19:29:01</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">wumpus:</span> there is a "For backport" column there...
<a name="l-117"></a><span class="tm">19:29:02</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/9792 | FastRandomContext improvements and switch to ChaCha20 by sipa Â· Pull Request #9792 Â· bitcoin/bitcoin Â· GitHub
<a name="l-118"></a><span class="tm">19:29:08</span><span class="nk"> &lt;wumpus&gt;</span> but I think we should be able to do 0.14.1 tomorrow so to have something to review for the rest of the week :D
<a name="l-119"></a><span class="tm">19:29:22</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">BlueMatt:</span> yes good point
<a name="l-120"></a><span class="tm">19:29:53</span><span class="nk"> &lt;BlueMatt&gt;</span> ok, so morcos and sdaftuar get to propose new ones since they dont have ones up, anyone else want to propose ones?
<a name="l-121"></a><span class="tm">19:29:55</span><span class="nk"> &lt;gmaxwell&gt;</span> oh someone opened a PR to do something with debug log excludes, and it adds more insane string processing in the debugging critical path. Would anyone mind if I brought back the PR I shelved to make debug categories use an enum?
<a name="l-122"></a><span class="tm">19:30:17</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">gmaxwell:</span> wfm, the pr was jnewbery's
<a name="l-123"></a><span class="tm">19:30:20</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">gmaxwell:</span> ack enum debug categories
<a name="l-124"></a><span class="tm">19:30:40</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> not sure
<a name="l-125"></a><span class="tm">19:30:43</span><span class="nk"> &lt;jnewbery&gt;</span> <span class="cmd">#10123</span><span class="cmdline"></span>
<a name="l-126"></a><span class="tm">19:30:44</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/10123 | Allow debug logs to be excluded from specified component by jnewbery Â· Pull Request #10123 Â· bitcoin/bitcoin Â· GitHub
<a name="l-127"></a><span class="tm">19:30:48</span><span class="nk"> &lt;gmaxwell&gt;</span> (the PR was just shelved because I opened it right before a release, and it is a conflict-the-universe PR)
<a name="l-128"></a><span class="tm">19:30:59</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> well no I guess it makes sense
<a name="l-129"></a><span class="tm">19:31:00</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">gmaxwell:</span> go for it now, I'd say
<a name="l-130"></a><span class="tm">19:31:05</span><span class="nk"> &lt;wumpus&gt;</span> yes, do it
<a name="l-131"></a><span class="tm">19:31:07</span><span class="nk"> &lt;sdaftuar&gt;</span> i'd like to get this DisconnectTip improvement wrapped up (#9208) but i need some help on resolving this annoying issue BlueMatt raised
<a name="l-132"></a><span class="tm">19:31:08</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/9208 | Improve DisconnectTip performance by sdaftuar Â· Pull Request #9208 Â· bitcoin/bitcoin Â· GitHub
<a name="l-133"></a><span class="tm">19:31:08</span><span class="nk"> &lt;cfields&gt;</span> <span class="hi">gmaxwell:</span> +1.
<a name="l-134"></a><span class="tm">19:31:14</span><span class="nk"> &lt;jonasschnelli&gt;</span> Yes. ACK
<a name="l-135"></a><span class="tm">19:31:23</span><span class="nk"> &lt;cfields&gt;</span> along the same lines, I'd like to do something similar for net messages
<a name="l-136"></a><span class="tm">19:31:23</span><span class="nk"> &lt;wumpus&gt;</span> then you can also map the enum values to strings and automate the help message generation
<a name="l-137"></a><span class="tm">19:31:26</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="cmd">#9424</span><span class="cmdline"></span>
<a name="l-138"></a><span class="tm">19:31:27</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/9424 | Change LogAcceptCategory to use uint32_t rather than sets of strings. by gmaxwell Â· Pull Request #9424 Â· bitcoin/bitcoin Â· GitHub
<a name="l-139"></a><span class="tm">19:31:30</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">sdaftuar:</span> want to bring it up now/
<a name="l-140"></a><span class="tm">19:31:38</span><span class="nk"> &lt;jnewbery&gt;</span> <span class="hi">gmaxwell:</span> +1. I'll happily review that one
<a name="l-141"></a><span class="tm">19:31:38</span><span class="nk"> &lt;BlueMatt&gt;</span> ?
<a name="l-142"></a><span class="tm">19:31:48</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">cfields:</span> yes, should be fairly easy to do, I already changed the syntax for net messages to be enum-like at some point
<a name="l-143"></a><span class="tm">19:31:49</span><span class="nk"> &lt;jtimon&gt;</span> since #8855 didn't got new review nor re-review I think just leave that (just remind to potential reviewers that #8994 continues it, in case you "don't see the point")
<a name="l-144"></a><span class="tm">19:31:51</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/8855 | Use a proper factory for creating chainparams by jtimon Â· Pull Request #8855 Â· bitcoin/bitcoin Â· GitHub
<a name="l-145"></a><span class="tm">19:31:51</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/8994 | Testchains: Introduce custom chain whose constructor... by jtimon Â· Pull Request #8994 Â· bitcoin/bitcoin Â· GitHub
<a name="l-146"></a><span class="tm">19:32:15</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">cfields:</span> went as far as I could without making it an actual enum :)
<a name="l-147"></a><span class="tm">19:32:17</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">cfields:</span> I looked at adding a perfect hash for net messages... but didn't know if that would be a way you'd want to go. :)
<a name="l-148"></a><span class="tm">19:32:29</span><span class="nk"> &lt;BlueMatt&gt;</span> new for review this week is 9792 and 9208
<a name="l-149"></a><span class="tm">19:32:35</span><span class="nk"> &lt;cfields&gt;</span> <span class="hi">wumpus:</span> yes, it sure looks like an enum :)
<a name="l-150"></a><span class="tm">19:32:37</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">gmaxwell:</span> just make sure all debug category names have different length
<a name="l-151"></a><span class="tm">19:33:12</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">sipa:</span> well we don't need to do any runtime lookup of category names at all.. so no need to do anything performant there.
<a name="l-152"></a><span class="tm">19:33:27</span><span class="nk"> &lt;wumpus&gt;</span> at least give them consecutive values so a bit field can be used to represent the set
<a name="l-153"></a><span class="tm">19:33:33</span><span class="nk"> &lt;wumpus&gt;</span> intead of a per-thread map :-(
<a name="l-154"></a><span class="tm">19:33:40</span><span class="nk"> &lt;cfields&gt;</span> <span class="hi">gmaxwell:</span> i had considered making it an array&lt;char, 12&gt;. But I really don't care, as long as it's switchable and a compile-time constant
<a name="l-155"></a><span class="tm">19:33:41</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> that is what PR 9424 does.
<a name="l-156"></a><span class="tm">19:33:52</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> ok, great
<a name="l-157"></a><span class="tm">19:33:53</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> it assigns them each to a bit.
<a name="l-158"></a><span class="tm">19:34:22</span><span class="nk"> &lt;wumpus&gt;</span> the current code that assigns it a thread-local variable is really strange
<a name="l-159"></a><span class="tm">19:34:27</span><span class="nk"> &lt;bitcoin-git&gt;</span> [13bitcoin] 15JeremyRubin opened pull request #10128: Speed Up CuckooCache tests (06master...06cuckoo-tests-faster) 02https://github.com/bitcoin/bitcoin/pull/10128
<a name="l-160"></a><span class="tm">19:34:30</span><span class="nk"> &lt;cfields&gt;</span> (and now that I think about it, std::array probably isn't switchable anyway)
<a name="l-161"></a><span class="tm">19:34:39</span><span class="nk"> &lt;gmaxwell&gt;</span> yes. horrors from beyond time.
<a name="l-162"></a><span class="tm">19:34:54</span><span class="nk"> &lt;sdaftuar&gt;</span> topic suggestion: dealing with abortnode / ConnectTip / DisconnectTip failures
<a name="l-163"></a><span class="tm">19:35:05</span><span class="nk"> &lt;gmaxwell&gt;</span> in any case, if people support-- 9424 is hard to rebase because it touches the whole codebase.
<a name="l-164"></a><span class="tm">19:35:30</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">cfields:</span> in some modern languages it's possible to switch on compound types and arrays and strings, but no, not c++XX before XX=50 or so :)
<a name="l-165"></a><span class="tm">19:35:33</span><span class="nk"> &lt;gmaxwell&gt;</span> but I think it also makes jnewbery's exclude trivial. (in fact: no runtime impact...)
<a name="l-166"></a><span class="tm">19:35:50</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> yes, it's how it should be done
<a name="l-167"></a><span class="tm">19:36:09</span><span class="nk"> &lt;sipa&gt;</span> in haskell it's pretty much the only way you can inspect a compound type at all :p
<a name="l-168"></a><span class="tm">19:36:14</span><span class="nk"> &lt;jnewbery&gt;</span> <span class="hi">gmaxwell:</span> agree
<a name="l-169"></a><span class="tm">19:36:22</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">sipa:</span> indeed
<a name="l-170"></a><span class="tm">19:36:41</span><span class="nk"> &lt;sipa&gt;</span> ok, sdaftuar's topic?
<a name="l-171"></a><span class="tm">19:36:46</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">cfields:</span> my intution for that would be using gperf to map the messages to integers. then switching on them... but perhaps overkill.
<a name="l-172"></a><span class="tm">19:36:53</span><span class="nk"> &lt;wumpus&gt;</span> <span class="topic">#topic </span><span class="topicline">dealing with abortnode / ConnectTip / DisconnectTip failures</span>
<a name="l-173"></a><span class="tm">19:37:05</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">context:</span> #9208
<a name="l-174"></a><span class="tm">19:37:06</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/9208 | Improve DisconnectTip performance by sdaftuar Â· Pull Request #9208 Â· bitcoin/bitcoin Â· GitHub
<a name="l-175"></a><span class="tm">19:37:09</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">sdaftuar:</span> i saw i was pinged in the PR, but haven't read it
<a name="l-176"></a><span class="tm">19:37:13</span><span class="nk"> &lt;sdaftuar&gt;</span> so this issue might be hard to grasp without reviewing #9208
<a name="l-177"></a><span class="tm">19:37:15</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/9208 | Improve DisconnectTip performance by sdaftuar Â· Pull Request #9208 Â· bitcoin/bitcoin Â· GitHub
<a name="l-178"></a><span class="tm">19:37:29</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> will that work for unknown messages too?
<a name="l-179"></a><span class="tm">19:37:40</span><span class="nk"> &lt;sdaftuar&gt;</span> but basically matt brought up that we have some edge cases in our code if ConnectTip or DisconnectTip return false
<a name="l-180"></a><span class="tm">19:37:54</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> does a perfect hash handle collisions? I don't remember
<a name="l-181"></a><span class="tm">19:38:07</span><span class="nk"> &lt;cfields&gt;</span> <span class="hi">wumpus:</span> perfect hash means no collisions :)
<a name="l-182"></a><span class="tm">19:38:13</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">cfields:</span> for known values
<a name="l-183"></a><span class="tm">19:38:34</span><span class="nk"> &lt;jeremyrubin&gt;</span> wouldn't that not be backwards compatible?
<a name="l-184"></a><span class="tm">19:38:36</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> gperf can check, it's an option.
<a name="l-185"></a><span class="tm">19:38:44</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">cfields:</span> but what if 'moo' maps to the same 32-bit value as 'block'
<a name="l-186"></a><span class="tm">19:38:50</span><span class="nk"> &lt;jeremyrubin&gt;</span> someone sends you a new type of message that hashes to something else
<a name="l-187"></a><span class="tm">19:39:05</span><span class="nk"> &lt;wumpus&gt;</span> scary
<a name="l-188"></a><span class="tm">19:39:06</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">sdaftuar:</span> hmm, i'll review the PR
<a name="l-189"></a><span class="tm">19:39:10</span><span class="nk"> &lt;sdaftuar&gt;</span> the last issue i'm trying to resolve is if ConnectTip fails (but the block is not invalid), then we should be in an AbortNode() state.  what consistency are we aiming for in this situation?
<a name="l-190"></a><span class="tm">19:39:14</span><span class="nk"> &lt;cfields&gt;</span> <span class="hi">wumpus:</span> ah, true
<a name="l-191"></a><span class="tm">19:39:16</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> making it never have collisions for unknows is just an extra comparison with the correct value.
<a name="l-192"></a><span class="tm">19:39:35</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> which IIRC the gperf emitted code will do, if enabled.
<a name="l-193"></a><span class="tm">19:39:47</span><span class="nk"> &lt;gmaxwell&gt;</span> (actually, looks like it's the default)
<a name="l-194"></a><span class="tm">19:39:47</span><span class="nk"> &lt;BlueMatt&gt;</span> lol, ok, so lets pick a topic instead of two
<a name="l-195"></a><span class="tm">19:40:16</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">sdaftuar:</span> we should be able to shut down and come back up with the underlying issue resolved and continue.
<a name="l-196"></a><span class="tm">19:40:26</span><span class="nk"> &lt;wumpus&gt;</span> yes, sorry, I was just curous about gperf
<a name="l-197"></a><span class="tm">19:40:30</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">sdaftuar:</span> I don't care if we lose a bunch of recent blocks.
<a name="l-198"></a><span class="tm">19:40:32</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">sdaftuar:</span> it's fine if we lose progress in that case, but if at all avoidable, the on disk state should not be corrupted
<a name="l-199"></a><span class="tm">19:40:44</span><span class="nk"> &lt;BlueMatt&gt;</span> anyway, so I further observed that shutdown upon AbortNode can take up to 200ms (see recent PR), which is somewhat frightening, given that mempool and chainstate may not be consistent which we assume in many places :/
<a name="l-200"></a><span class="tm">19:40:46</span><span class="nk"> &lt;sdaftuar&gt;</span> <span class="hi">gmaxwell:</span> sipa: what should we do with the mempool?
<a name="l-201"></a><span class="tm">19:41:03</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">sdaftuar:</span> who cares?
<a name="l-202"></a><span class="tm">19:41:08</span><span class="nk"> &lt;BlueMatt&gt;</span> so we keep running for a while normally and possibly have incorrect assumptions
<a name="l-203"></a><span class="tm">19:41:11</span><span class="nk"> &lt;gmaxwell&gt;</span> I don't care.
<a name="l-204"></a><span class="tm">19:41:16</span><span class="nk"> &lt;wumpus&gt;</span> just drop it
<a name="l-205"></a><span class="tm">19:41:29</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">sdaftuar:</span> at restart we'll try to reimport what is on disk
<a name="l-206"></a><span class="tm">19:41:36</span><span class="nk"> &lt;sipa&gt;</span> and re-run all necessary consistency checks
<a name="l-207"></a><span class="tm">19:41:51</span><span class="nk"> &lt;sipa&gt;</span> so mempool.dat doesn't need to be consistent with the chainstate
<a name="l-208"></a><span class="tm">19:41:59</span><span class="nk"> &lt;BlueMatt&gt;</span> and wallet?
<a name="l-209"></a><span class="tm">19:42:01</span><span class="nk"> &lt;sdaftuar&gt;</span> i think the concern matt was raising was if before shutdown, it's possible for eg an RPC call to get incorrect results
<a name="l-210"></a><span class="tm">19:42:04</span><span class="nk"> &lt;sdaftuar&gt;</span> or the wallet
<a name="l-211"></a><span class="tm">19:42:08</span><span class="nk"> &lt;wumpus&gt;</span> yes, no tight coupling, good design
<a name="l-212"></a><span class="tm">19:42:19</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">wumpus:</span> point is we *have* tight coupling
<a name="l-213"></a><span class="tm">19:42:22</span><span class="nk"> &lt;wumpus&gt;</span> wallet doesn't need to be in sync either, though it should not be ahead
<a name="l-214"></a><span class="tm">19:42:24</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">sdaftuar:</span> ugh
<a name="l-215"></a><span class="tm">19:42:28</span><span class="nk"> &lt;BlueMatt&gt;</span> and continue running after realizing something is corrupted
<a name="l-216"></a><span class="tm">19:42:35</span><span class="nk"> &lt;gmaxwell&gt;</span> well abortnode should be instant-ish.
<a name="l-217"></a><span class="tm">19:42:42</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">BlueMatt:</span> so you're fixing that, what is there to discuss?
<a name="l-218"></a><span class="tm">19:42:46</span><span class="nk"> &lt;wumpus&gt;</span> a bit behind (as long as it's not further than the prune distance) is ok, it will catch up in next start
<a name="l-219"></a><span class="tm">19:42:49</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">gmaxwell:</span> i mean the new pr is an improvement, but its not a fix
<a name="l-220"></a><span class="tm">19:43:02</span><span class="nk"> &lt;BlueMatt&gt;</span> its not like you cant have something pending cs_main when coming out of Disconnect/ConnectTip
<a name="l-221"></a><span class="tm">19:43:06</span><span class="nk"> &lt;wumpus&gt;</span> but if the wallet is ahead of the chain it will trigger a rescan IIRC
<a name="l-222"></a><span class="tm">19:43:10</span><span class="nk"> &lt;gmaxwell&gt;</span> so perhaps abortnode needs to Abort()?
<a name="l-223"></a><span class="tm">19:43:18</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">gmaxwell:</span> thats pretty much the question
<a name="l-224"></a><span class="tm">19:43:21</span><span class="nk"> &lt;BlueMatt&gt;</span> thats super shit, though, of course
<a name="l-225"></a><span class="tm">19:43:24</span><span class="nk"> &lt;gmaxwell&gt;</span> and not faffabout witht politely shutting off threads.
<a name="l-226"></a><span class="tm">19:43:24</span><span class="nk"> &lt;wumpus&gt;</span> I don't think so
<a name="l-227"></a><span class="tm">19:43:39</span><span class="nk"> &lt;sdaftuar&gt;</span> i inadvertently introduced an assert failure in one of these situations.  maybe that's a feature not a flaw! :)
<a name="l-228"></a><span class="tm">19:43:44</span><span class="nk"> &lt;gmaxwell&gt;</span> Why is it shit? we should be durable across a power off, which is worse than aborting.
<a name="l-229"></a><span class="tm">19:43:45</span><span class="nk"> &lt;wumpus&gt;</span> the point of abortnode is to be able to show a GUI dialog to the user
<a name="l-230"></a><span class="tm">19:43:55</span><span class="nk"> &lt;gmaxwell&gt;</span> ah
<a name="l-231"></a><span class="tm">19:43:57</span><span class="nk"> &lt;wumpus&gt;</span> if you abort() the user will never know to check the debug.log
<a name="l-232"></a><span class="tm">19:44:07</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">wumpus:</span> well we can show a gui dialog and abort() prior to unlocking cs_main
<a name="l-233"></a><span class="tm">19:44:09</span><span class="nk"> &lt;BlueMatt&gt;</span> :P
<a name="l-234"></a><span class="tm">19:44:15</span><span class="nk"> &lt;jeremyrubin&gt;</span> have a graceful shutdown falg
<a name="l-235"></a><span class="tm">19:44:19</span><span class="nk"> &lt;jeremyrubin&gt;</span> *flag
<a name="l-236"></a><span class="tm">19:44:24</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> but it's not unlikely that we can't show a gui... if we can't allocate (likely cause).
<a name="l-237"></a><span class="tm">19:44:27</span><span class="nk"> &lt;BlueMatt&gt;</span> which would effectively be sufficient
<a name="l-238"></a><span class="tm">19:44:29</span><span class="nk"> &lt;wumpus&gt;</span> I always thought that AbortNode was for errors that could tolerate a graceful shutdown
<a name="l-239"></a><span class="tm">19:44:35</span><span class="nk"> &lt;wumpus&gt;</span> the really terrible errors we already assert() or abort() on
<a name="l-240"></a><span class="tm">19:44:36</span><span class="nk"> &lt;jeremyrubin&gt;</span> and if we're shutting down gracefully, write to a file "was graceful"
<a name="l-241"></a><span class="tm">19:44:41</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">gmaxwell:</span> AbortNode() is usually disk corruption
<a name="l-242"></a><span class="tm">19:44:45</span><span class="nk"> &lt;jeremyrubin&gt;</span> On next start, show dialogue first thing?
<a name="l-243"></a><span class="tm">19:44:46</span><span class="nk"> &lt;wumpus&gt;</span> please don't make it routine to abort() for everything
<a name="l-244"></a><span class="tm">19:44:53</span><span class="nk"> &lt;wumpus&gt;</span> only for things that really warrant it
<a name="l-245"></a><span class="tm">19:45:00</span><span class="nk"> &lt;wumpus&gt;</span> not crash on every single error
<a name="l-246"></a><span class="tm">19:45:02</span><span class="nk"> &lt;BlueMatt&gt;</span> or too little disk space
<a name="l-247"></a><span class="tm">19:45:02</span><span class="nk"> &lt;sdaftuar&gt;</span> or too little disk space, not quite teh same as corruption
<a name="l-248"></a><span class="tm">19:45:03</span><span class="nk"> &lt;wumpus&gt;</span> that's just a mess
<a name="l-249"></a><span class="tm">19:45:21</span><span class="nk"> &lt;gmaxwell&gt;</span> okay, sure.
<a name="l-250"></a><span class="tm">19:45:24</span><span class="nk"> &lt;wumpus&gt;</span> for some problems it's fine to try to clean up normally
<a name="l-251"></a><span class="tm">19:45:31</span><span class="nk"> &lt;wumpus&gt;</span> but we still need to exit with a message
<a name="l-252"></a><span class="tm">19:45:34</span><span class="nk"> &lt;wumpus&gt;</span> that's what abortnode is for
<a name="l-253"></a><span class="tm">19:45:56</span><span class="nk"> &lt;wumpus&gt;</span> if BlueMatt can make it work faster that's great, but don't silently kill the program on every error
<a name="l-254"></a><span class="tm">19:46:18</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> how about every other error?
<a name="l-255"></a><span class="tm">19:46:26</span><span class="nk"> &lt;gmaxwell&gt;</span> :P
<a name="l-256"></a><span class="tm">19:46:33</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> hehe
<a name="l-257"></a><span class="tm">19:46:59</span><span class="nk"> &lt;sipa&gt;</span> do #9208 and #9725 interact?
<a name="l-258"></a><span class="tm">19:47:01</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/9208 | Improve DisconnectTip performance by sdaftuar Â· Pull Request #9208 Â· bitcoin/bitcoin Â· GitHub
<a name="l-259"></a><span class="tm">19:47:03</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/9725 | CValidationInterface Cleanups by TheBlueMatt Â· Pull Request #9725 Â· bitcoin/bitcoin Â· GitHub
<a name="l-260"></a><span class="tm">19:47:07</span><span class="nk"> &lt;gmaxwell&gt;</span> Y'all so worried about the dressings on the coffin.  "It's already dead!"  But sure. Sorry I was only thinking of OOM, it's just a recent subject.
<a name="l-261"></a><span class="tm">19:47:19</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">sipa:</span> they dont, afaik, aside from there now being two structs that can be merged
<a name="l-262"></a><span class="tm">19:47:22</span><span class="nk"> &lt;jeremyrubin&gt;</span> I think deleting a file on graceful shutdown should work
<a name="l-263"></a><span class="tm">19:47:42</span><span class="nk"> &lt;jeremyrubin&gt;</span> And then starting when that file is present shows the dialouge rather than starting
<a name="l-264"></a><span class="tm">19:47:46</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">gmaxwell:</span> yea, AbortNode isnt used for thigns like OOM and total death
<a name="l-265"></a><span class="tm">19:47:49</span><span class="nk"> &lt;BlueMatt&gt;</span> disk space also does it
<a name="l-266"></a><span class="tm">19:47:55</span><span class="nk"> &lt;BlueMatt&gt;</span> but it can also be db corruption
<a name="l-267"></a><span class="tm">19:48:13</span><span class="nk"> &lt;jeremyrubin&gt;</span> This means you don't do anything at all on the Abort, but requires the user to restart their node to see the message
<a name="l-268"></a><span class="tm">19:48:15</span><span class="nk"> &lt;BlueMatt&gt;</span> so maybe the solution is AbortNode gets renamed to ShutdownSoon() and use make sure disk corruption is something different?
<a name="l-269"></a><span class="tm">19:48:31</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">BlueMatt:</span> yes, makes sense to me
<a name="l-270"></a><span class="tm">19:48:33</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">BlueMatt:</span> or add a flag
<a name="l-271"></a><span class="tm">19:48:38</span><span class="nk"> &lt;morcos&gt;</span> I haven't really thought this all the way through, but doesn't it seem that as we move more and more towards things happening in other threads, that you'd rather let those threads finish what they are doing
<a name="l-272"></a><span class="tm">19:48:45</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">BlueMatt:</span> you could also harden things up against your current concer by having the rpc stuff always check the shutdown flag right after taking cs_main (whenever it does)?
<a name="l-273"></a><span class="tm">19:48:47</span><span class="nk"> &lt;morcos&gt;</span> If you're committing wallet changes for instance
<a name="l-274"></a><span class="tm">19:48:59</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">BlueMatt:</span> and if it finds out that its on its way down, just returning at that point.
<a name="l-275"></a><span class="tm">19:49:06</span><span class="nk"> &lt;wumpus&gt;</span> in the long run morcos we should move toward looser coupling of things
<a name="l-276"></a><span class="tm">19:49:09</span><span class="nk"> &lt;wumpus&gt;</span> I agree
<a name="l-277"></a><span class="tm">19:49:13</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">gmaxwell:</span> yea, I'm worried that if we start down that path we have to check it everywhere
<a name="l-278"></a><span class="tm">19:49:22</span><span class="nk"> &lt;BlueMatt&gt;</span> eg wallet may make decisions based on some corrupted mempool state
<a name="l-279"></a><span class="tm">19:49:27</span><span class="nk"> &lt;morcos&gt;</span> Let's say you just got some new address from the wallet, and the wallet hasn't committed that state yet and then you Abort()
<a name="l-280"></a><span class="tm">19:49:31</span><span class="nk"> &lt;BlueMatt&gt;</span> (I havent thought all the way through all the potential issues here, just a potential concern)
<a name="l-281"></a><span class="tm">19:50:19</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">morcos:</span> luckily we have the keypool to handle that specific contingency
<a name="l-282"></a><span class="tm">19:50:24</span><span class="nk"> &lt;jeremyrubin&gt;</span> Every thread could have their own unique ungraceful-close file that it should delete (via RAII) on clean exit. Starting with any present would show error. Uncoupled!
<a name="l-283"></a><span class="tm">19:50:40</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">morcos:</span> well at least the worst you get there is replay (due to keypool/hdwallets).. though replay can be pretty bad.
<a name="l-284"></a><span class="tm">19:51:11</span><span class="nk"> &lt;wumpus&gt;</span> pretty bad but well at least they will never lose live keys
<a name="l-285"></a><span class="tm">19:51:47</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">jeremyrubin:</span> I have a feeling we can be more agressive on the super-strange issues, afaiu this stuff is pretty much hit just with out-of-disk everything else is rare enough.....
<a name="l-286"></a><span class="tm">19:52:36</span><span class="nk"> &lt;sipa&gt;</span> maybe we should just have some std::atomic&lt;bool&gt; shits_on_fire_yo; which when set prevents RPCs etc
<a name="l-287"></a><span class="tm">19:52:46</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">jeremyrubin:</span> that's not what I mean with uncoupling, what I mean is that if one thread messes up it doesn't need to take the others with it because it can operate more-or-less independently
<a name="l-288"></a><span class="tm">19:52:58</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">sipa:</span> well shutdown can be more or less that.
<a name="l-289"></a><span class="tm">19:53:14</span><span class="nk"> &lt;sipa&gt;</span> that can even be set from a signal handler
<a name="l-290"></a><span class="tm">19:53:34</span><span class="nk"> &lt;BlueMatt&gt;</span> 20&lt;BlueMatt&gt;30 so maybe the solution is AbortNode gets renamed to ShutdownSoon() and use make sure disk corruption is something different?
<a name="l-291"></a><span class="tm">19:53:53</span><span class="nk"> &lt;jeremyrubin&gt;</span> <span class="hi">sipa:</span> what do you do with an in progress RPC?
<a name="l-292"></a><span class="tm">19:54:04</span><span class="nk"> &lt;BlueMatt&gt;</span> in ShutdownSoon cases (eg out of disk) we're ok to continue and just shut down, i think
<a name="l-293"></a><span class="tm">19:54:08</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">jeremyrubin:</span> we can only do so much
<a name="l-294"></a><span class="tm">19:54:08</span><span class="nk"> &lt;wumpus&gt;</span> you can't generally break off an in-progress RPC
<a name="l-295"></a><span class="tm">19:54:11</span><span class="nk"> &lt;BlueMatt&gt;</span> in other cases, we can just assert(false)
<a name="l-296"></a><span class="tm">19:54:13</span><span class="nk"> &lt;wumpus&gt;</span> although some will pay attention to fShutdown
<a name="l-297"></a><span class="tm">19:54:15</span><span class="nk"> &lt;BlueMatt&gt;</span> because they're super rare anyway
<a name="l-298"></a><span class="tm">19:54:21</span><span class="nk"> &lt;jeremyrubin&gt;</span> <span class="hi">wumpus:</span> ^ yes, O
<a name="l-299"></a><span class="tm">19:54:21</span><span class="nk"> &lt;gmaxwell&gt;</span> but really, what probably should be done is having the rpcs being able to handle being told "No, you can't have access to [whatever chain state you wanted] right now."  then these error conditions that could leave them unstable... could set them.
<a name="l-300"></a><span class="tm">19:54:26</span><span class="nk"> &lt;BlueMatt&gt;</span> and if your disk is corrupted we probably shouldnt be flushing wallet and chainstate as a part of shutdown anyway
<a name="l-301"></a><span class="tm">19:54:47</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">gmaxwell:</span> yea, but thats a huge rewrite for cases that should be super rare
<a name="l-302"></a><span class="tm">19:55:11</span><span class="nk"> &lt;gmaxwell&gt;</span> Or we take a whole different approach to failure messages, .e.g. wrap bitcoin-qt in another program that when qt exists it can go through the logs and give you a useful error. (though this doesn't answer morcos' wallet flush, but really that should be in another process.)
<a name="l-303"></a><span class="tm">19:55:26</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">BlueMatt:</span> I think there should be a clear separation between (A) I/O issues such as out of disk spae, which just happen regularly (B) rare implementation issues such as internal consistency errors
<a name="l-304"></a><span class="tm">19:55:27</span><span class="nk"> &lt;cfields&gt;</span> iirc rpc has a IsRPCShuttingDown() or so, but only a few things (gbt only, maybe?) checks it
<a name="l-305"></a><span class="tm">19:55:28</span><span class="nk"> &lt;jeremyrubin&gt;</span> <span class="hi">wumpus:</span> * yes, I'm aware that isn't quite what you meant, just making noise about having a graceful shutdown file because I think it's a reasonable way to mark if a node shut down dirty
<a name="l-306"></a><span class="tm">19:55:44</span><span class="nk"> &lt;wumpus&gt;</span> (A) normal errors should just give the user an error as AbortNode does now and shut down properly
<a name="l-307"></a><span class="tm">19:56:02</span><span class="nk"> &lt;wumpus&gt;</span> (B) internal state corruption errors could break off the process immediately
<a name="l-308"></a><span class="tm">19:56:02</span><span class="nk"> &lt;gmaxwell&gt;</span> It's obnoxious that we can't preallocate resources such that we can guarentee that we never take a failure at an inoppturtune time.
<a name="l-309"></a><span class="tm">19:56:14</span><span class="nk"> &lt;gmaxwell&gt;</span> having to slather the code in error handling to deal with that is not ideal.
<a name="l-310"></a><span class="tm">19:56:41</span><span class="nk"> &lt;jeremyrubin&gt;</span> <span class="hi">gmaxwell:</span> you can preallocate lots of things?
<a name="l-311"></a><span class="tm">19:56:44</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> "I had to abort processing a block" is a weak kind of internal state corruption. It leaves assumed invariants violated.
<a name="l-312"></a><span class="tm">19:56:57</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">jeremyrubin:</span> in particular we can't make leveldb's disk usage constant.
<a name="l-313"></a><span class="tm">19:56:58</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">wumpus:</span> yes, thats my proposal
<a name="l-314"></a><span class="tm">19:57:12</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">wumpus:</span> but, specifically, B would include things like chainstate-on-disk-corruption
<a name="l-315"></a><span class="tm">19:57:17</span><span class="nk"> &lt;BlueMatt&gt;</span> which it already partially does, just not completely
<a name="l-316"></a><span class="tm">19:57:26</span><span class="nk"> &lt;wumpus&gt;</span> having code to handle normal errors is perfectly normal and all code has that, I agree that paranoid memory/disk corruption errors tend not to be possible to handle in a sane way
<a name="l-317"></a><span class="tm">19:57:33</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">BlueMatt:</span> yes
<a name="l-318"></a><span class="tm">19:57:48</span><span class="nk"> &lt;BlueMatt&gt;</span> ok, soooo, acks on:&lt;BlueMatt&gt; &lt;BlueMatt&gt; so maybe the solution is AbortNode gets renamed to ShutdownSoon() and use make sure disk corruption is something different?
<a name="l-319"></a><span class="tm">19:58:07</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">BlueMatt:</span> as I said beforer, yes, that or add a flag/criticality level
<a name="l-320"></a><span class="tm">19:58:11</span><span class="nk"> &lt;BlueMatt&gt;</span> s/use make sure/make sure/
<a name="l-321"></a><span class="tm">19:58:15</span><span class="nk"> &lt;jeremyrubin&gt;</span> <span class="hi">BlueMatt:</span> maybe if you paste it again
<a name="l-322"></a><span class="tm">19:58:15</span><span class="nk"> &lt;BlueMatt&gt;</span> sure, that too
<a name="l-323"></a><span class="tm">19:58:23</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">jeremyrubin:</span> ok, &lt;BlueMatt&gt; ok, soooo, acks on:&lt;BlueMatt&gt; &lt;BlueMatt&gt; so maybe the solution is AbortNode gets renamed to ShutdownSoon() and use make sure disk corruption is something different?
<a name="l-324"></a><span class="tm">19:58:39</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> for example, if we run out of space while flushing our view of the blockchain will be corrupt, and information about the blockchain from rpcs will be wrong.  In a world where error handling is free, every code path that gets access to the blockchain data would be able to gracefully handle being told it's just not available.  But I think that would be an unreasonable and dangerous amount
<a name="l-325"></a><span class="tm">19:58:45</span><span class="nk"> &lt;gmaxwell&gt;</span> of complexity. :(
<a name="l-326"></a><span class="tm">19:58:50</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">wumpus:</span> I missed that statement, but, yes
<a name="l-327"></a><span class="tm">19:59:00</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">BlueMatt:</span> that sounds okay to me. but I don't know that diskfull is really a shutdown soon though we really do need to give it a nice message. :(
<a name="l-328"></a><span class="tm">19:59:03</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> note that the out-of-disk error happens *before* the disk is entirely full
<a name="l-329"></a><span class="tm">19:59:04</span><span class="nk"> &lt;jeremyrubin&gt;</span> <span class="hi">BlueMatt:</span> sgtm
<a name="l-330"></a><span class="tm">19:59:12</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> there's a threshold
<a name="l-331"></a><span class="tm">19:59:22</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> so that should already be mitigated
<a name="l-332"></a><span class="tm">19:59:26</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> yes, but it's not atomic. you can't check and then successfully allocate space.
<a name="l-333"></a><span class="tm">19:59:38</span><span class="nk"> &lt;wumpus&gt;</span> no, it's not perfect, but it works pretty well
<a name="l-334"></a><span class="tm">19:59:43</span><span class="nk"> &lt;wumpus&gt;</span> I've never had corruption on full disk
<a name="l-335"></a><span class="tm">20:00:33</span><span class="nk"> &lt;wumpus&gt;</span> also leveldb write failing shouldn't generally be fatal
<a name="l-336"></a><span class="tm">20:00:39</span><span class="nk"> &lt;gmaxwell&gt;</span> on my desktop, which runs with debug=1 it almost always gets checked at the start of the flush. It doesn't corrupt things on disk, but as matt points out the rpc would return somewhat incorrect results during that time.
<a name="l-337"></a><span class="tm">20:00:39</span><span class="nk"> &lt;wumpus&gt;</span> it just means the last transaction is not committed
<a name="l-338"></a><span class="tm">20:01:00</span><span class="nk"> &lt;jtimon&gt;</span> it seems it's time to abort the meeting
<a name="l-339"></a><span class="tm">20:01:06</span><span class="nk"> &lt;wumpus&gt;</span> <span class="cmd">#endmeeting</span><span class="cmdline"></span></pre>
</body></html>
