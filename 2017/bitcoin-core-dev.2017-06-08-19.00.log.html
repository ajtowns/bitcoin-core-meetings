<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<title>#bitcoin-core-dev log</title>
<style type="text/css">
/* For the .log.html */
pre { /*line-height: 125%;*/
      white-space: pre-wrap; }
body { background: #f0f0f0; }

body .tm  { color: #007020 }                      /* time */
body .nk  { color: #062873; font-weight: bold }   /* nick, regular */
body .nka { color: #007020; font-weight: bold }  /* action nick */
body .ac  { color: #00A000 }                      /* action line */
body .hi  { color: #4070a0 }                 /* hilights */
/* Things to make particular MeetBot commands stick out */
body .topic     { color: #007020; font-weight: bold }
body .topicline { color: #000080; font-weight: bold }
body .cmd       { color: #007020; font-weight: bold }
body .cmdline  { font-weight: bold }

</style>
</head>

<body>
<pre><a name="l-1"></a><span class="tm">19:00:04</span><span class="nk"> &lt;wumpus&gt;</span> <span class="cmd">#startmeeting</span><span class="cmdline"></span>
<a name="l-2"></a><span class="tm">19:00:04</span><span class="nk"> &lt;lightningbot&gt;</span> Meeting started Thu Jun  8 19:00:04 2017 UTC.  The chair is wumpus. Information about MeetBot at http://wiki.debian.org/MeetBot.
<a name="l-3"></a><span class="tm">19:00:04</span><span class="nk"> &lt;lightningbot&gt;</span> Useful Commands: #action #agreed #help #info #idea #link #topic.
<a name="l-4"></a><span class="tm">19:00:07</span><span class="nk"> &lt;wumpus&gt;</span> <span class="cmd">#bitcoin-core-dev </span><span class="cmdline">Meeting: wumpus sipa gmaxwell jonasschnelli morcos luke-jr btcdrak sdaftuar jtimon cfields petertodd kanzure bluematt instagibbs phantomcircuit codeshark michagogo marcofalke paveljanik NicolasDorier jl2012 instagibbs</span>
<a name="l-5"></a><span class="tm">19:00:10</span><span class="nk"> &lt;jonasschnelli&gt;</span> hi
<a name="l-6"></a><span class="tm">19:00:12</span><span class="nk"> &lt;sdaftuar&gt;</span> hi
<a name="l-7"></a><span class="tm">19:00:14</span><span class="nk"> &lt;sipa&gt;</span> hi
<a name="l-8"></a><span class="tm">19:00:15</span><span class="nk"> &lt;achow101&gt;</span> hi
<a name="l-9"></a><span class="tm">19:00:29</span><span class="nk"> &lt;wumpus&gt;</span> proposed topics?
<a name="l-10"></a><span class="tm">19:00:49</span><span class="nk"> &lt;kanzure&gt;</span> hi.
<a name="l-11"></a><span class="tm">19:00:51</span><span class="nk"> &lt;sipa&gt;</span> UI interaction with pertxout upgrade?
<a name="l-12"></a><span class="tm">19:00:57</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="cmd">#bitcoin-core-dev </span><span class="cmdline">Meeting: wumpus sipa gmaxwell jonasschnelli morcos luke-jr btcdrak sdaftuar jtimon cfields petertodd kanzure bluematt instagibbs phantomcircuit codeshark michagogo marcofalke paveljanik NicolasDorier</span>
<a name="l-13"></a><span class="tm">19:01:07</span><span class="nk"> &lt;jonasschnelli&gt;</span> <span class="hi">sipa:</span> ack
<a name="l-14"></a><span class="tm">19:01:33</span><span class="nk"> &lt;wumpus&gt;</span> ok, let's do high priority for review first, then that
<a name="l-15"></a><span class="tm">19:01:37</span><span class="nk"> &lt;wumpus&gt;</span> <span class="topic">#topic </span><span class="topicline">high priority for review</span>
<a name="l-16"></a><span class="tm">19:01:54</span><span class="nk"> &lt;sipa&gt;</span> <span class="cmd">#10148</span><span class="cmdline"></span>
<a name="l-17"></a><span class="tm">19:01:56</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/10148 | Use non-atomic flushing with block replay by sipa · Pull Request #10148 · bitcoin/bitcoin · GitHub
<a name="l-18"></a><span class="tm">19:01:59</span><span class="nk"> &lt;luke-jr&gt;</span> I've rebased multiwallet etc
<a name="l-19"></a><span class="tm">19:02:08</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">luke-jr:</span> great!
<a name="l-20"></a><span class="tm">19:02:12</span><span class="nk"> &lt;sipa&gt;</span> (^ will double our effectively available dbcache)
<a name="l-21"></a><span class="tm">19:02:30</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">luke-jr:</span> sae there were some new review comments, did you address them yet?
<a name="l-22"></a><span class="tm">19:03:00</span><span class="nk"> &lt;luke-jr&gt;</span> <span class="hi">wumpus:</span> I believe all review comments are addressed or answered
<a name="l-23"></a><span class="tm">19:03:12</span><span class="nk"> &lt;wumpus&gt;</span> added 10148
<a name="l-24"></a><span class="tm">19:03:15</span><span class="nk"> &lt;sipa&gt;</span> thanks!
<a name="l-25"></a><span class="tm">19:03:51</span><span class="nk"> &lt;jtimon&gt;</span> still waiting on my current one, thanks wumpus for benchmarking
<a name="l-26"></a><span class="tm">19:03:58</span><span class="nk"> &lt;jonasschnelli&gt;</span> <span class="cmd">#8694 </span><span class="cmdline">now passes gitian, will re-utack soon</span>
<a name="l-27"></a><span class="tm">19:04:01</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/8694 | Basic multiwallet support by luke-jr · Pull Request #8694 · bitcoin/bitcoin · GitHub
<a name="l-28"></a><span class="tm">19:04:13</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">jtimon:</span> a very nice gain!
<a name="l-29"></a><span class="tm">19:04:38</span><span class="nk"> &lt;luke-jr&gt;</span> oh, there was a comment asking for tests..
<a name="l-30"></a><span class="tm">19:04:52</span><span class="nk"> &lt;luke-jr&gt;</span> I didn't write any, although I agree they would be nice
<a name="l-31"></a><span class="tm">19:04:55</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">jtimon:</span> unfortunately bitcoind nuked my log so I can't get the timings, but 26% savings in block hash operations is noce
<a name="l-32"></a><span class="tm">19:05:06</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">wumpus:</span> nice
<a name="l-33"></a><span class="tm">19:05:37</span><span class="nk"> &lt;jtimon&gt;</span> we're talking about #10339 in case someone is lost
<a name="l-34"></a><span class="tm">19:05:40</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/10339 | Optimization: Calculate block hash less times by jtimon · Pull Request #10339 · bitcoin/bitcoin · GitHub
<a name="l-35"></a><span class="tm">19:05:43</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">luke-jr:</span> well I'd say add those later, this is only the first in a series towards multiwallet after all
<a name="l-36"></a><span class="tm">19:06:02</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">wumpus:</span> status on account to label conversion?
<a name="l-37"></a><span class="tm">19:06:02</span><span class="nk"> &lt;luke-jr&gt;</span> indeed, it might not be possible to test right now since it's not exposed to RPC
<a name="l-38"></a><span class="tm">19:06:06</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">wumpus:</span> "in block hash operations" hmm? can you be more specific?
<a name="l-39"></a><span class="tm">19:06:08</span><span class="nk"> &lt;gmaxwell&gt;</span> Related to hashing, does anyone here have AMD ryzen yet?
<a name="l-40"></a><span class="tm">19:06:12</span><span class="nk"> &lt;BlueMatt&gt;</span> whats that compared to total runtime?
<a name="l-41"></a><span class="tm">19:06:32</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">BlueMatt:</span> I don't know about time, I just instrumented the block header hash function
<a name="l-42"></a><span class="tm">19:06:34</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">BlueMatt:</span> it's tiny vs total runtime, I assume-- but it should impact latency on block handling somewhat.
<a name="l-43"></a><span class="tm">19:06:38</span><span class="nk"> &lt;luke-jr&gt;</span> <span class="hi">gmaxwell:</span> no, but I'd been holding out for SHA2 acceleration before upgrading, so I might get one if AMD is competing with Intel again
<a name="l-44"></a><span class="tm">19:06:55</span><span class="nk"> &lt;sipa&gt;</span> related topic: sha2/crc32 hw accel?
<a name="l-45"></a><span class="tm">19:07:08</span><span class="nk"> &lt;wumpus&gt;</span> as I said, I lost the timings (blame bitcoind nuking the log if it's too large)
<a name="l-46"></a><span class="tm">19:07:11</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">luke-jr:</span> Ryzen has the sha2 instructions... so I'm asking to find out if anyone will be able to test support for them. :)
<a name="l-47"></a><span class="tm">19:07:23</span><span class="nk"> &lt;luke-jr&gt;</span> <span class="hi">gmaxwell:</span> right, that's why ;)
<a name="l-48"></a><span class="tm">19:07:48</span><span class="nk"> &lt;luke-jr&gt;</span> I just haven't had time to investigate the pros/cons otherwise yet
<a name="l-49"></a><span class="tm">19:07:58</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">sipa:</span> no progress on that yet
<a name="l-50"></a><span class="tm">19:08:02</span><span class="nk"> &lt;gmaxwell&gt;</span> In any case, 98% of the work needed to support sha2 instructions is the same as using SSE4 SHA2 which will itself be a non-trival speedup.
<a name="l-51"></a><span class="tm">19:08:29</span><span class="nk"> &lt;wumpus&gt;</span> crc speedup should be possible after the leveldb upgrade that sipa PRed
<a name="l-52"></a><span class="tm">19:08:39</span><span class="nk"> &lt;luke-jr&gt;</span> <span class="hi">gmaxwell:</span> we removed SSE4 stuff years ago, but I'm not sure if it was used for non-mining
<a name="l-53"></a><span class="tm">19:08:49</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">luke-jr:</span> it was only used for mining at the time
<a name="l-54"></a><span class="tm">19:08:50</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">BlueMatt:</span> IIRC I instrumented and measured accepting a block at tip hashed the header ~6 times or so.
<a name="l-55"></a><span class="tm">19:08:53</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">luke-jr:</span> it was mining only.
<a name="l-56"></a><span class="tm">19:09:00</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">luke-jr:</span> that was a different one, the N-way-parallel
<a name="l-57"></a><span class="tm">19:09:11</span><span class="nk"> &lt;sipa&gt;</span> yup 4-way parallel SSE2, iirc
<a name="l-58"></a><span class="tm">19:09:11</span><span class="nk"> &lt;gmaxwell&gt;</span> and it was a vector SHA2 that had to work on 4 elements at a time.
<a name="l-59"></a><span class="tm">19:09:36</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">gmaxwell:</span> that's before or after the patch?
<a name="l-60"></a><span class="tm">19:09:37</span><span class="nk"> &lt;gmaxwell&gt;</span> What we should be implementing now is the one at a time SIMD sha2.  I believe matt uses it in fibre but without autodetection.
<a name="l-61"></a><span class="tm">19:09:38</span><span class="nk"> &lt;sipa&gt;</span> it seems we've strayed from the topic?
<a name="l-62"></a><span class="tm">19:09:41</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">jtimon:</span> before.
<a name="l-63"></a><span class="tm">19:09:41</span><span class="nk"> &lt;luke-jr&gt;</span> I wonder if it'd be worth using 4-way for merkle trees etc
<a name="l-64"></a><span class="tm">19:09:42</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">gmaxwell:</span> yea, but if its not measurable on the total, unlikely to be worth the effort and complexity.....an alternative - do we have CBlockIndex*es in most of those places? pblockindex-&gt;GetBlockHash() is free and simpler than passing hashes around
<a name="l-65"></a><span class="tm">19:09:45</span><span class="nk"> &lt;jonasschnelli&gt;</span> Will have access to a Ryzen in a couple of days via Hetzner
<a name="l-66"></a><span class="tm">19:10:13 </span><span class="nka">* luke-jr</span> <span class="ac">wonders if the GCC compile farm has a Ryzen</span>
<a name="l-67"></a><span class="tm">19:10:37</span><span class="nk"> &lt;morcos&gt;</span> Without doing a thorough review of 10339, is the speedup worth it as opposed to the tradeoff on making the code a little more complicated/involved.  Who was it that said the primary point of source code is to communicate between developers
<a name="l-68"></a><span class="tm">19:10:51</span><span class="nk"> &lt;jonasschnelli&gt;</span> <span class="cmd">#10339</span><span class="cmdline"></span>
<a name="l-69"></a><span class="tm">19:10:53</span><span class="nk"> &lt;morcos&gt;</span> It just seems weird to pass a block and separately it's hash into a bunch of functions
<a name="l-70"></a><span class="tm">19:10:53</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/10339 | Optimization: Calculate block hash less times by jtimon · Pull Request #10339 · bitcoin/bitcoin · GitHub
<a name="l-71"></a><span class="tm">19:11:07</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">BlueMatt:</span> what's wrong with passing hashes around?
<a name="l-72"></a><span class="tm">19:11:26</span><span class="nk"> &lt;BlueMatt&gt;</span> DoPartOfConnectBlock(42 args)
<a name="l-73"></a><span class="tm">19:11:27</span><span class="nk"> &lt;wumpus&gt;</span> <span class="topic">#topic </span><span class="topicline">Optimization: Calculate block hash less times by jtimon</span>
<a name="l-74"></a><span class="tm">19:11:35</span><span class="nk"> &lt;BlueMatt&gt;</span> we already have too many args in many of those functions
<a name="l-75"></a><span class="tm">19:11:38</span><span class="nk"> &lt;instagibbs&gt;</span> "fewer" :P
<a name="l-76"></a><span class="tm">19:11:54</span><span class="nk"> &lt;wumpus&gt;</span> well if hashing is a bottleneck, the obvious optimization is to just to it less
<a name="l-77"></a><span class="tm">19:11:56</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">instagibbs:</span> i didn't want to say anything :)
<a name="l-78"></a><span class="tm">19:12:04</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">wumpus:</span> is it?
<a name="l-79"></a><span class="tm">19:12:08</span><span class="nk"> &lt;wumpus&gt;</span> if hashing is not a bottleneck, then going after SSE and such makes no sense either
<a name="l-80"></a><span class="tm">19:12:26</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">BlueMatt:</span> i believe that in all places where we already have CBlockIndex, no new block hashes are computed
<a name="l-81"></a><span class="tm">19:12:34</span><span class="nk"> &lt;sipa&gt;</span> all of the cases in 10339 are before having a CBlockIndex
<a name="l-82"></a><span class="tm">19:12:39</span><span class="nk"> &lt;wumpus&gt;</span> so if #10339 is not an improvement then we can leave hashing alone
<a name="l-83"></a><span class="tm">19:12:41</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/10339 | Optimization: Calculate block hash less times by jtimon · Pull Request #10339 · bitcoin/bitcoin · GitHub
<a name="l-84"></a><span class="tm">19:12:44</span><span class="nk"> &lt;gmaxwell&gt;</span> Well my suggestion on that hash thing was just to cache the hash in the block object, but Pieter said he prefered this.
<a name="l-85"></a><span class="tm">19:12:46</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">instagibbs:</span> calculate fewer times? thanks
<a name="l-86"></a><span class="tm">19:12:59</span><span class="nk"> &lt;gmaxwell&gt;</span> (I also implemented that, though in a way that wasn't correct for the mining code.)
<a name="l-87"></a><span class="tm">19:13:06</span><span class="nk"> &lt;BlueMatt&gt;</span> <span class="hi">gmaxwell:</span> I highly prefer that, though making CBlock const ala CTransaction is a bit more involved
<a name="l-88"></a><span class="tm">19:13:09</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">gmaxwell:</span> if we create another CBlock for the cases where that's not needed
<a name="l-89"></a><span class="tm">19:13:18</span><span class="nk"> &lt;sipa&gt;</span> (like GetTransaction and mining code)
<a name="l-90"></a><span class="tm">19:13:26</span><span class="nk"> &lt;jtimon&gt;</span> Node also that we're sometimes getting the hash from the index and sometimes from the CBlock
<a name="l-91"></a><span class="tm">19:13:38</span><span class="nk"> &lt;wumpus&gt;</span> right, calculating it eagerly can also result in overhead
<a name="l-92"></a><span class="tm">19:13:43</span><span class="nk"> &lt;morcos&gt;</span> I'd just like to see some evidence, even a little bit, that this optimization is worth it.  26% fewer hashing operations results in what savings?  Or do people not agree it makes the code a bit more cumbersome
<a name="l-93"></a><span class="tm">19:14:07</span><span class="nk"> &lt;sipa&gt;</span> i don't see much problem in passing a hash along with a block if you know it
<a name="l-94"></a><span class="tm">19:14:21</span><span class="nk"> &lt;BlueMatt&gt;</span> passing in the hash as a part of ProcessNewBlock? yuck
<a name="l-95"></a><span class="tm">19:14:22</span><span class="nk"> &lt;sipa&gt;</span> it's certainly a bit of complication, but a trivial one
<a name="l-96"></a><span class="tm">19:14:22</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">morcos:</span> sure, my point is just that if 26% fewer hashing operations isn't worth it, then using special intstructions to gain a few % is netiher worth it
<a name="l-97"></a><span class="tm">19:14:25</span><span class="nk"> &lt;CodeShark&gt;</span> seems like there are probably lower hanging fruit in optimizations but meh
<a name="l-98"></a><span class="tm">19:14:28</span><span class="nk"> &lt;BlueMatt&gt;</span> I just spent a bunch of time getting fewer args there
<a name="l-99"></a><span class="tm">19:14:45</span><span class="nk"> &lt;morcos&gt;</span> <span class="hi">wumpus:</span> well hashing occurs a lot more often than in the calculations of these block hashes
<a name="l-100"></a><span class="tm">19:14:52</span><span class="nk"> &lt;BlueMatt&gt;</span> to separate the consensus code from net_processing, now we're adding more coupling :(
<a name="l-101"></a><span class="tm">19:14:53</span><span class="nk"> &lt;jtimon&gt;</span> it seems to me that the reserve is mostly a question of style
<a name="l-102"></a><span class="tm">19:14:54</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">morcos:</span> My reason for bringing it up is that I believe the repeated hashing is on the latency critical path for block propagation to the tune of maybe a millisecond-ish.
<a name="l-103"></a><span class="tm">19:15:08</span><span class="nk"> &lt;jtimon&gt;</span> I mean calculating it eagerly can penalize in some cases, right
<a name="l-104"></a><span class="tm">19:15:22</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> these optimizations just prevent repeated hashing of the headers, in terms of total bytes hashed while syncing thats pretty small even though we do have a high repetition factor.
<a name="l-105"></a><span class="tm">19:15:36</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">jtimon:</span> what case would computing it early peanalize?
<a name="l-106"></a><span class="tm">19:15:37</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> ok...
<a name="l-107"></a><span class="tm">19:15:38</span><span class="nk"> &lt;CodeShark&gt;</span> <span class="hi">BlueMatt:</span> my preference is to sacrifice a little performance for better architecture ;)
<a name="l-108"></a><span class="tm">19:15:42</span><span class="nk"> &lt;sdaftuar&gt;</span> i will try to benchmark the effect on validation speed for this
<a name="l-109"></a><span class="tm">19:15:52</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">CodeShark:</span> I think that's a fair argument
<a name="l-110"></a><span class="tm">19:15:56</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">wumpus:</span> transaction hashing accounts for far more than block header hashing, but not on the critical path
<a name="l-111"></a><span class="tm">19:16:02</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">gmaxwell:</span> when the validation fails for some other reason before you need the hash?
<a name="l-112"></a><span class="tm">19:16:04 </span><span class="nka">* BlueMatt</span> <span class="ac">would be more ok if we calculated it at the top of ProcessNewBlock and pass that one around, but still not ideal</span>
<a name="l-113"></a><span class="tm">19:16:11</span><span class="nk"> &lt;BlueMatt&gt;</span> passing it in to ProcessNewBlock is.....ugh
<a name="l-114"></a><span class="tm">19:16:36</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">jtimon:</span> I don't think there is any validation failure path where we don't hash... after all, we'll want to know _what_ block hash failed to validate.
<a name="l-115"></a><span class="tm">19:16:38</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">BlueMatt:</span> you could have said that when each function had a separated commit, but I can leave that out
<a name="l-116"></a><span class="tm">19:16:46</span><span class="nk"> &lt;BlueMatt&gt;</span> or, really, chnging the signatures of stuff in validation.h for this without a benchmark showing its a real win :(
<a name="l-117"></a><span class="tm">19:16:58</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">gmaxwell:</span> yeah, fair enough
<a name="l-118"></a><span class="tm">19:17:16 </span><span class="nka">* morcos</span> <span class="ac">has said his piece and is willing to let the people who spent more time thinking about this decide</span>
<a name="l-119"></a><span class="tm">19:17:22</span><span class="nk"> &lt;wumpus&gt;</span> ok, clear, better to close it I guess, would have made sense to have this discussion earlier
<a name="l-120"></a><span class="tm">19:17:24</span><span class="nk"> &lt;jtimon&gt;</span> so we come back to only the "ugh" argument
<a name="l-121"></a><span class="tm">19:17:40</span><span class="nk"> &lt;gmaxwell&gt;</span> But I still don't understand why sipa prefered to do this jtimon patch instead of making the object cache it.   FWIW, just monkey patching it 'works' and the only obvious issue is mining.
<a name="l-122"></a><span class="tm">19:17:57</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">gmaxwell:</span> and every other read from disk
<a name="l-123"></a><span class="tm">19:18:46</span><span class="nk"> &lt;jtimon&gt;</span> I preferred this because I think it's simpler than the cache, even if it's "ugh"
<a name="l-124"></a><span class="tm">19:18:49</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">sipa:</span> I don't understand your comment.
<a name="l-125"></a><span class="tm">19:18:54</span><span class="nk"> &lt;sipa&gt;</span> i consider adding more arguments to validation-specific functions less invasively than changing a primitive datastructure
<a name="l-126"></a><span class="tm">19:18:58</span><span class="nk"> &lt;sipa&gt;</span> we can do both, if needed
<a name="l-127"></a><span class="tm">19:19:16</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">sipa:</span> I tend to agree
<a name="l-128"></a><span class="tm">19:19:26</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">gmaxwell:</span> i believe we often read blocks from disk without caring about its hash, because we already know it
<a name="l-129"></a><span class="tm">19:19:35</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">sipa:</span> just passing extra arguments is easier to reason about than extending primitive datastructures
<a name="l-130"></a><span class="tm">19:19:39</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">sipa:</span> the read funcion computes it!
<a name="l-131"></a><span class="tm">19:19:46</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">gmaxwell:</span> ?
<a name="l-132"></a><span class="tm">19:20:01</span><span class="nk"> &lt;sipa&gt;</span> currently, yes, as a checksum
<a name="l-133"></a><span class="tm">19:20:17</span><span class="nk"> &lt;sipa&gt;</span> if we care about the checksum functionality, we should add a crc
<a name="l-134"></a><span class="tm">19:20:20</span><span class="nk"> &lt;gmaxwell&gt;</span> // Check the header
<a name="l-135"></a><span class="tm">19:20:20</span><span class="nk"> &lt;gmaxwell&gt;</span> if (!CheckProofOfWork(block.GetHash(), block.nBits, consensusParams))
<a name="l-136"></a><span class="tm">19:20:20</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">jtimon:</span> I agree, caching is always somewhat risky and error prone, this is more explicit and clear
<a name="l-137"></a><span class="tm">19:20:23</span><span class="nk"> &lt;gmaxwell&gt;</span> return error("ReadBlockFromDisk: Errors in block header at %s", pos.ToString());
<a name="l-138"></a><span class="tm">19:20:48</span><span class="nk"> &lt;wumpus&gt;</span> then again if it's not worth it, performanec wise, we shouldn't do it at all
<a name="l-139"></a><span class="tm">19:20:52</span><span class="nk"> &lt;wumpus&gt;</span> not in another way either
<a name="l-140"></a><span class="tm">19:21:02</span><span class="nk"> &lt;sipa&gt;</span> making the block hash part of CBlock makes us unable to skip computing that hash
<a name="l-141"></a><span class="tm">19:21:09</span><span class="nk"> &lt;sipa&gt;</span> even in places where we don't care about it
<a name="l-142"></a><span class="tm">19:21:13</span><span class="nk"> &lt;gmaxwell&gt;</span> I think I previously gave figures on the latency impact of caching.
<a name="l-143"></a><span class="tm">19:21:17</span><span class="nk"> &lt;jtimon&gt;</span> how can I benchmark this to convince morcos?
<a name="l-144"></a><span class="tm">19:21:34</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">sipa:</span> Where are those places?
<a name="l-145"></a><span class="tm">19:21:34</span><span class="nk"> &lt;wumpus&gt;</span> I don't know, I tried
<a name="l-146"></a><span class="tm">19:22:09</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">gmaxwell:</span> every time we read a block from disk, we already have its hash (because that's how we look it up!)
<a name="l-147"></a><span class="tm">19:22:26</span><span class="nk"> &lt;sdaftuar&gt;</span> <span class="hi">sipa:</span> don't we also hash all the transactions when we read a block from disk?
<a name="l-148"></a><span class="tm">19:22:28</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">gmaxwell:</span> recomputing it there serves as nothing more than a checksum
<a name="l-149"></a><span class="tm">19:22:30</span><span class="nk"> &lt;sdaftuar&gt;</span> surely that dominates all this
<a name="l-150"></a><span class="tm">19:22:34</span><span class="nk"> &lt;morcos&gt;</span> <span class="hi">sipa:</span> i know i said i'd shut up, but you just read from DISK, who cares if you hash 80 bytes?
<a name="l-151"></a><span class="tm">19:22:41</span><span class="nk"> &lt;wumpus&gt;</span> might be time for next topic, if this is not a perf issue, might be better to discuss it after meeting
<a name="l-152"></a><span class="tm">19:22:57</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">sdaftuar:</span> good point.
<a name="l-153"></a><span class="tm">19:23:02</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">sdaftuar:</span> we don't. I used to think we did but we do not.
<a name="l-154"></a><span class="tm">19:23:15</span><span class="nk"> &lt;sipa&gt;</span> yes, we do
<a name="l-155"></a><span class="tm">19:23:23</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">sipa:</span> where?
<a name="l-156"></a><span class="tm">19:23:32</span><span class="nk"> &lt;sipa&gt;</span> deserializing a transaction computes its hash
<a name="l-157"></a><span class="tm">19:23:50</span><span class="nk"> &lt;gmaxwell&gt;</span> oh right, what we don't do is validate the hashroot.
<a name="l-158"></a><span class="tm">19:23:53</span><span class="nk"> &lt;sipa&gt;</span> let's discuss this after the meeting
<a name="l-159"></a><span class="tm">19:23:59</span><span class="nk"> &lt;gmaxwell&gt;</span> k
<a name="l-160"></a><span class="tm">19:24:45</span><span class="nk"> &lt;sipa&gt;</span> next topic?
<a name="l-161"></a><span class="tm">19:24:56</span><span class="nk"> &lt;wumpus&gt;</span> <span class="topic">#topic </span><span class="topicline">UI interaction with pertxout upgrade</span>
<a name="l-162"></a><span class="tm">19:25:16</span><span class="nk"> &lt;jtimon&gt;</span> in any case, BlueMatt morcos if you already knew you didn't liked this, I would have appreaciated knowing it earlier, maybe a provisional concept NACK or something
<a name="l-163"></a><span class="tm">19:25:45</span><span class="nk"> &lt;sipa&gt;</span> so, since 10195, we'll have a possibly lengthy (minutes on decent hardware, possibly much longer elsewhere) upgrade process from the old per-txid utxo db to the per-txout one
<a name="l-164"></a><span class="tm">19:25:52</span><span class="nk"> &lt;morcos&gt;</span> <span class="hi">jtimon:</span> yes sorry, i only looked at the PR during todays meeting, also why i said i'd stop arguing about it
<a name="l-165"></a><span class="tm">19:26:04</span><span class="nk"> &lt;sipa&gt;</span> that needs some GUI interaction, i believe
<a name="l-166"></a><span class="tm">19:26:08</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">jtimon:</span> same here, this should have been clear sooner, otherwise I wouldn't have spent as much time on it
<a name="l-167"></a><span class="tm">19:26:19</span><span class="nk"> &lt;sipa&gt;</span> or perhaps even in bitcoind
<a name="l-168"></a><span class="tm">19:26:36</span><span class="nk"> &lt;morcos&gt;</span> <span class="hi">wumpus:</span> in general perf improvements shoudl include data in the PR request when possible I think
<a name="l-169"></a><span class="tm">19:26:40</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">jtimon:</span> it's kind of disappointing to discover this does what it says on the tin, save ~1/4th of block hash operations, just to discover that's not even important
<a name="l-170"></a><span class="tm">19:26:44</span><span class="nk"> &lt;jonasschnelli&gt;</span> Can you not just use uiInterface.Progress() like in VerifyDB?
<a name="l-171"></a><span class="tm">19:26:45</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">jtimon:</span> that kind of annoys me
<a name="l-172"></a><span class="tm">19:26:57</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">jonasschnelli:</span> that doesn't let you interrupt
<a name="l-173"></a><span class="tm">19:27:07</span><span class="nk"> &lt;morcos&gt;</span> <span class="hi">sipa:</span> yeah i noticed that it doesn't even output to debug log that its doing an upgrade right?
<a name="l-174"></a><span class="tm">19:27:14</span><span class="nk"> &lt;sipa&gt;</span> it should log
<a name="l-175"></a><span class="tm">19:27:19</span><span class="nk"> &lt;sipa&gt;</span> "Upgrading database..."
<a name="l-176"></a><span class="tm">19:27:20</span><span class="nk"> &lt;luke-jr&gt;</span> <span class="hi">jonasschnelli:</span> I'd think users should be able to send txs during the upgrade.
<a name="l-177"></a><span class="tm">19:27:21</span><span class="nk"> &lt;morcos&gt;</span> oh
<a name="l-178"></a><span class="tm">19:27:40</span><span class="nk"> &lt;jonasschnelli&gt;</span> <span class="hi">luke-jr:</span> but RPC is also not ready in this case? RIght?
<a name="l-179"></a><span class="tm">19:27:44</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">morcos:</span> it logs, but you won't see it if you have leveldb logging turned on. :P
<a name="l-180"></a><span class="tm">19:27:46</span><span class="nk"> &lt;sipa&gt;</span> nothing works during the upgrade
<a name="l-181"></a><span class="tm">19:27:51</span><span class="nk"> &lt;sipa&gt;</span> there is no full node available
<a name="l-182"></a><span class="tm">19:28:05</span><span class="nk"> &lt;jonasschnelli&gt;</span> why would you then need interruption?
<a name="l-183"></a><span class="tm">19:28:10</span><span class="nk"> &lt;wumpus&gt;</span> it should at least show a progress indicator and be interruptible indeed, ideally
<a name="l-184"></a><span class="tm">19:28:13</span><span class="nk"> &lt;sipa&gt;</span> because maybe it takes too long
<a name="l-185"></a><span class="tm">19:28:20</span><span class="nk"> &lt;sipa&gt;</span> and they want to continue another time
<a name="l-186"></a><span class="tm">19:28:36</span><span class="nk"> &lt;wumpus&gt;</span> yes, because the user may want to do something else with the computer, having not expected to have to spend a long time upgrading
<a name="l-187"></a><span class="tm">19:28:44</span><span class="nk"> &lt;gmaxwell&gt;</span> by interruption this means 'crash', not continue running without the upgrade.
<a name="l-188"></a><span class="tm">19:28:44</span><span class="nk"> &lt;jtimon&gt;</span> anyway, I would still like to benchmark it if anyone can help me (not sure what to do)
<a name="l-189"></a><span class="tm">19:28:50</span><span class="nk"> &lt;jonasschnelli&gt;</span> Ah.. the update can be done in multiple steps..
<a name="l-190"></a><span class="tm">19:28:57</span><span class="nk"> &lt;sipa&gt;</span> yes
<a name="l-191"></a><span class="tm">19:28:58</span><span class="nk"> &lt;jonasschnelli&gt;</span> well that would also need communication then
<a name="l-192"></a><span class="tm">19:28:59</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> well 'exit' not crash
<a name="l-193"></a><span class="tm">19:29:07</span><span class="nk"> &lt;gmaxwell&gt;</span> same difference
<a name="l-194"></a><span class="tm">19:29:10</span><span class="nk"> &lt;morcos&gt;</span> <span class="hi">sipa:</span> yeah i missed that somehow, sorry
<a name="l-195"></a><span class="tm">19:29:13</span><span class="nk"> &lt;sipa&gt;</span> crashing "should" be fine
<a name="l-196"></a><span class="tm">19:29:29</span><span class="nk"> &lt;gmaxwell&gt;</span> it better be! :) (also, I've tested it a fair bit)
<a name="l-197"></a><span class="tm">19:29:30</span><span class="nk"> &lt;jonasschnelli&gt;</span> [Updating 0%] \n You can shutdown and continue later [Shutdown-Button] &lt;-- something like that?
<a name="l-198"></a><span class="tm">19:29:37</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">jtimon:</span> benchmarking the reindex chainstate maybe?
<a name="l-199"></a><span class="tm">19:29:39</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">jonasschnelli:</span> like that.
<a name="l-200"></a><span class="tm">19:29:39</span><span class="nk"> &lt;luke-jr&gt;</span> what if you crash, run the old version, and then the new one again?
<a name="l-201"></a><span class="tm">19:29:47</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">jtimon:</span> I still wonder why -stopatblock doesn't work
<a name="l-202"></a><span class="tm">19:30:18</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">luke-jr:</span> you get to keep both pieces? (I believe the old version will tell you the database is corrupt and stop there.... but I haven't tested that, so it's a good question.)
<a name="l-203"></a><span class="tm">19:30:21</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">wumpus:</span> no; that's dominated by tx validation/deserialization... a good benchmark tests block validation given fully populated mempool and sigcache etc
<a name="l-204"></a><span class="tm">19:30:29</span><span class="nk"> &lt;jonasschnelli&gt;</span> How about logging? Can we log similar to the VerifyDB [the non-newline % steps]?
<a name="l-205"></a><span class="tm">19:30:38</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">jonasschnelli:</span> sure
<a name="l-206"></a><span class="tm">19:30:40</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">sipa:</span> ok...
<a name="l-207"></a><span class="tm">19:30:48</span><span class="nk"> &lt;jonasschnelli&gt;</span> I can work on that. Seems to fit my skillset. :)
<a name="l-208"></a><span class="tm">19:30:51</span><span class="nk"> &lt;luke-jr&gt;</span> <span class="hi">gmaxwell:</span> IMO users may get tired of waiting and prefer to start the upgrade over in exchange for being able to use the old version in the meantime
<a name="l-209"></a><span class="tm">19:30:51</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">sipa:</span> perhaps it could be as simple as using -upgradeutxodb=1 once or something of the sort?
<a name="l-210"></a><span class="tm">19:30:52</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">sipa:</span> good luck doing that in a deterministic way, though
<a name="l-211"></a><span class="tm">19:30:53</span><span class="nk"> &lt;sipa&gt;</span> maybe VerifyDB or something like that can pass a bool saying "interruptible" ?
<a name="l-212"></a><span class="tm">19:31:04</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">luke-jr:</span> sounds like a case we should handle.
<a name="l-213"></a><span class="tm">19:31:05</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">jtimon:</span> you can't not do it
<a name="l-214"></a><span class="tm">19:31:29</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">jtimon:</span> i mean, -upgradeutxodb=0 would mean just exiting immediately :)
<a name="l-215"></a><span class="tm">19:31:37</span><span class="nk"> &lt;wumpus&gt;</span> no, the upgrade needs to be done
<a name="l-216"></a><span class="tm">19:31:42</span><span class="nk"> &lt;luke-jr&gt;</span> we could prompt before starting to warn the user, but IMO we'd probably want to begin ASAP, even if we hold off destroying backward compat until the user OKs it
<a name="l-217"></a><span class="tm">19:31:51</span><span class="nk"> &lt;gmaxwell&gt;</span> meh.
<a name="l-218"></a><span class="tm">19:32:01</span><span class="nk"> &lt;wumpus&gt;</span> sure, you could warn...
<a name="l-219"></a><span class="tm">19:32:07</span><span class="nk"> &lt;gmaxwell&gt;</span> Keep in mind that on a reasonably fast computer the upgrade does not take long.
<a name="l-220"></a><span class="tm">19:32:07</span><span class="nk"> &lt;jtimon&gt;</span> no, I mean once you set -upgradeutxodb=1 once it doesn't matter what you set anymore
<a name="l-221"></a><span class="tm">19:32:09</span><span class="nk"> &lt;sipa&gt;</span> it's a new major release, i don't care about backward compatibility; the user can always reindex if they really need to
<a name="l-222"></a><span class="tm">19:32:13</span><span class="nk"> &lt;morcos&gt;</span> so just to be clear, right now if someone went back to an old version, there is some chance they'd screw themselves right?
<a name="l-223"></a><span class="tm">19:32:23</span><span class="nk"> &lt;morcos&gt;</span> (and need to reindex)
<a name="l-224"></a><span class="tm">19:32:32</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">morcos:</span> yes, it simply doesn't work. We should warn in the release notes.
<a name="l-225"></a><span class="tm">19:32:37</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">morcos:</span> i believe that with very high probability the startup sanity check will fail
<a name="l-226"></a><span class="tm">19:32:38</span><span class="nk"> &lt;luke-jr&gt;</span> pruned nodes cant reindex
<a name="l-227"></a><span class="tm">19:32:44</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">morcos:</span> old version rejects with a "your database is corrupted"  though luke was asking an interesting question about what happens if you do this mid-conversion.
<a name="l-228"></a><span class="tm">19:33:02</span><span class="nk"> &lt;wumpus&gt;</span> we coudl have added logic to 0.14.2 to detect the new format and give a more specific error
<a name="l-229"></a><span class="tm">19:33:03</span><span class="nk"> &lt;morcos&gt;</span> <span class="hi">sipa:</span> yeah that was my question, how far do you have to get along in the upgrade before your sanity check would fail with high probability
<a name="l-230"></a><span class="tm">19:33:07</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">sipa:</span> I did test that case, how could it not fail?
<a name="l-231"></a><span class="tm">19:33:25</span><span class="nk"> &lt;sdaftuar&gt;</span> we only go back 6 blocks now in the startup sanity check i think
<a name="l-232"></a><span class="tm">19:33:26</span><span class="nk"> &lt;luke-jr&gt;</span> <span class="hi">wumpus:</span> IMO it'd be better to destroy the upgrade so it starts over, and work (for incomplete upgrades)
<a name="l-233"></a><span class="tm">19:33:31</span><span class="nk"> &lt;sdaftuar&gt;</span> isn't it possible you don't come across any bad entries?
<a name="l-234"></a><span class="tm">19:33:35</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> hm? I don't think that would be the right way, the right way would be to make the new version more incompatible.
<a name="l-235"></a><span class="tm">19:33:53</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> ok...
<a name="l-236"></a><span class="tm">19:34:02</span><span class="nk"> &lt;sipa&gt;</span> there is a trivial change we can make that guarantees old versions will treat it as an empty db
<a name="l-237"></a><span class="tm">19:34:24</span><span class="nk"> &lt;luke-jr&gt;</span> change the dir name?
<a name="l-238"></a><span class="tm">19:34:28</span><span class="nk"> &lt;sipa&gt;</span> haha
<a name="l-239"></a><span class="tm">19:34:31</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> I just mean a specific error like 'the utxo database is in a newer format than supported by this version' would be clearer than a general sanity check error
<a name="l-240"></a><span class="tm">19:34:33</span><span class="nk"> &lt;sipa&gt;</span> yes, i've considered that too
<a name="l-241"></a><span class="tm">19:34:34</span><span class="nk"> &lt;morcos&gt;</span> empty db == corrupt and leave it so the new version can continue
<a name="l-242"></a><span class="tm">19:34:39</span><span class="nk"> &lt;gmaxwell&gt;</span> no there is just the height index entry.
<a name="l-243"></a><span class="tm">19:34:39</span><span class="nk"> &lt;morcos&gt;</span> wumpus +1
<a name="l-244"></a><span class="tm">19:34:45</span><span class="nk"> &lt;wumpus&gt;</span> but I don't know ,sorry for suggesting it
<a name="l-245"></a><span class="tm">19:34:46</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> oh, sure that would have been okay!
<a name="l-246"></a><span class="tm">19:34:51</span><span class="nk"> &lt;morcos&gt;</span> thats at least somethign we shoudl do  for future changes
<a name="l-247"></a><span class="tm">19:34:51</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">wumpus:</span> unfortunately it doesn't have a version number
<a name="l-248"></a><span class="tm">19:34:55</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">luke-jr:</span> we could move the main datadir to ./bitcoin/main maybe
<a name="l-249"></a><span class="tm">19:34:55</span><span class="nk"> &lt;sipa&gt;</span> agree
<a name="l-250"></a><span class="tm">19:34:57</span><span class="nk"> &lt;luke-jr&gt;</span> using a new db would also mean users from pre-obfuscation get that enabled..
<a name="l-251"></a><span class="tm">19:35:10</span><span class="nk"> &lt;sipa&gt;</span> a new db is a possibility
<a name="l-252"></a><span class="tm">19:35:18</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">sipa:</span> we could have added one! but yes, too late.
<a name="l-253"></a><span class="tm">19:35:19</span><span class="nk"> &lt;sipa&gt;</span> though i'd prefer to not need 2x disk storage during the upgrade
<a name="l-254"></a><span class="tm">19:35:25</span><span class="nk"> &lt;sipa&gt;</span> not too late
<a name="l-255"></a><span class="tm">19:35:27</span><span class="nk"> &lt;morcos&gt;</span> <span class="hi">sipa:</span> what was the trivial change you were referring to
<a name="l-256"></a><span class="tm">19:35:45</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">morcos:</span> change the record name for the 'best block hash' entry
<a name="l-257"></a><span class="tm">19:35:52</span><span class="nk"> &lt;gmaxwell&gt;</span> the database stores a record to indicate the current tip; we can just change that.
<a name="l-258"></a><span class="tm">19:35:56</span><span class="nk"> &lt;sipa&gt;</span> and set the old one to something invalid
<a name="l-259"></a><span class="tm">19:36:23</span><span class="nk"> &lt;luke-jr&gt;</span> [19:35:19] &lt;sipa&gt; though i'd prefer to not need 2x disk storage during the upgrade &lt;-- IMO unavoidable if the "user gets tired of waiting and runs old version" is desired to work okay
<a name="l-260"></a><span class="tm">19:36:32</span><span class="nk"> &lt;gmaxwell&gt;</span> FWIW the non-atomic flushing change already changes those records around.
<a name="l-261"></a><span class="tm">19:36:39</span><span class="nk"> &lt;sipa&gt;</span> yup
<a name="l-262"></a><span class="tm">19:36:46</span><span class="nk"> &lt;sipa&gt;</span> well, in a backward compatible way
<a name="l-263"></a><span class="tm">19:36:47</span><span class="nk"> &lt;gmaxwell&gt;</span> I don't think we should support user gets tired of waiting.
<a name="l-264"></a><span class="tm">19:36:59</span><span class="nk"> &lt;gmaxwell&gt;</span> too high a cost for too low a benefit.
<a name="l-265"></a><span class="tm">19:36:59</span><span class="nk"> &lt;sipa&gt;</span> it's even easier if it doesn't need to be backward compatible
<a name="l-266"></a><span class="tm">19:37:15</span><span class="nk"> &lt;morcos&gt;</span> <span class="hi">gmaxwell:</span> yes we shouldn't support it, but it might be nice to support they tried to do it and didn't corrupt their database by trying so they now have to reindex
<a name="l-267"></a><span class="tm">19:37:41</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">morcos:</span> yes, in practice that is the case but it isn't guarenteed. We could make it guarenteed.
<a name="l-268"></a><span class="tm">19:37:44</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> well just exiting and continuing the upgrade later would be ok
<a name="l-269"></a><span class="tm">19:38:02</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">wumpus:</span> yea, that works except we don't have an exit button other than kill -9 :)
<a name="l-270"></a><span class="tm">19:38:03</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">wumpus:</span> also, i don't understand why the CompactRange doesn't work for you
<a name="l-271"></a><span class="tm">19:38:21</span><span class="nk"> &lt;sipa&gt;</span> if it's not guaranteed (or even not likely) to work, maybe the 2x disk storage is inevitable
<a name="l-272"></a><span class="tm">19:38:27</span><span class="nk"> &lt;sipa&gt;</span> and we're better off explicitly creating a new db
<a name="l-273"></a><span class="tm">19:38:36</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">sipa:</span> I don't know either, could try it again if you think it's a fluke...
<a name="l-274"></a><span class="tm">19:38:48</span><span class="nk"> &lt;sipa&gt;</span> i'll test it myself again too
<a name="l-275"></a><span class="tm">19:38:51</span><span class="nk"> &lt;gmaxwell&gt;</span> I tested an earlier range compacting patch and it did work.
<a name="l-276"></a><span class="tm">19:39:00</span><span class="nk"> &lt;gmaxwell&gt;</span> I'll also test.
<a name="l-277"></a><span class="tm">19:39:21</span><span class="nk"> &lt;sipa&gt;</span> monitor disk usage during upgrade, with and without compactrange patch
<a name="l-278"></a><span class="tm">19:39:23</span><span class="nk"> &lt;sipa&gt;</span> would be nice
<a name="l-279"></a><span class="tm">19:39:37</span><span class="nk"> &lt;sipa&gt;</span> and maybe this discussion depends on the outcome there
<a name="l-280"></a><span class="tm">19:39:58</span><span class="nk"> &lt;gmaxwell&gt;</span> if indeed compacting isn't reliable we should change to create a new database. IMO
<a name="l-281"></a><span class="tm">19:40:05</span><span class="nk"> &lt;sipa&gt;</span> agree
<a name="l-282"></a><span class="tm">19:40:30</span><span class="nk"> &lt;wumpus&gt;</span> it might have to do with my test framework, I'll copy the database directory next time instead of using my usual hardlink hack
<a name="l-283"></a><span class="tm">19:41:02</span><span class="nk"> &lt;gmaxwell&gt;</span> (FWIW, the reason I checked compacting before is because I was going to suggest changing to a new database if it didn't work.)
<a name="l-284"></a><span class="tm">19:41:06</span><span class="nk"> &lt;wumpus&gt;</span> other topics?
<a name="l-285"></a><span class="tm">19:41:27</span><span class="nk"> &lt;sipa&gt;</span> crc32 leveldb 1.20?
<a name="l-286"></a><span class="tm">19:41:32</span><span class="nk"> &lt;gmaxwell&gt;</span> ^
<a name="l-287"></a><span class="tm">19:41:41</span><span class="nk"> &lt;wumpus&gt;</span> <span class="topic">#topic </span><span class="topicline">crc32 leveldb 1.20</span>
<a name="l-288"></a><span class="tm">19:41:41</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">gmaxwell:</span> agreed on cost/benefit for supporting interruption, much easier to require confirmation with a warning "this may take a while and cannot be interrupted" or something
<a name="l-289"></a><span class="tm">19:42:07</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">sipa:</span> Why is travis failing?
<a name="l-290"></a><span class="tm">19:42:09</span><span class="nk"> &lt;sipa&gt;</span> i personally really dislike the approach they're using (which seems to be the advised way even), which requires a separate object compiled with different flags
<a name="l-291"></a><span class="tm">19:42:25</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">gmaxwell:</span> i assume incompatibility with our own build system integration of leveldb
<a name="l-292"></a><span class="tm">19:42:35</span><span class="nk"> &lt;wumpus&gt;</span> compiling a separate object with special flags is  pretty much the standard way of doing it
<a name="l-293"></a><span class="tm">19:42:57</span><span class="nk"> &lt;sipa&gt;</span> they're even abusing it... they're calling the new object without knowing that the CPU supports it
<a name="l-294"></a><span class="tm">19:43:25</span><span class="nk"> &lt;wumpus&gt;</span> ok, that's not good
<a name="l-295"></a><span class="tm">19:43:27</span><span class="nk"> &lt;gmaxwell&gt;</span> Compiling a new object with different flags is standard and correct,  calling it without knowing, is wrong.
<a name="l-296"></a><span class="tm">19:43:33</span><span class="nk"> &lt;wumpus&gt;</span> yes
<a name="l-297"></a><span class="tm">19:43:45</span><span class="nk"> &lt;wumpus&gt;</span> the detection function should not be in that object
<a name="l-298"></a><span class="tm">19:43:46</span><span class="nk"> &lt;sipa&gt;</span> the approach in #10377 is so much easier
<a name="l-299"></a><span class="tm">19:43:48</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/10377 | Use rdrand as entropy source on supported platforms by sipa · Pull Request #10377 · bitcoin/bitcoin · GitHub
<a name="l-300"></a><span class="tm">19:43:49</span><span class="nk"> &lt;wumpus&gt;</span> simple as that
<a name="l-301"></a><span class="tm">19:44:34</span><span class="nk"> &lt;wumpus&gt;</span> that only works because you don't spell out the instruction but put it in binary, if you spelled out the instruction it would have to be compiled with a special flag
<a name="l-302"></a><span class="tm">19:44:56</span><span class="nk"> &lt;wumpus&gt;</span> you can't use e.g. sse4.2 instructions if the object isn't compiled with that
<a name="l-303"></a><span class="tm">19:45:00</span><span class="nk"> &lt;gmaxwell&gt;</span> IIRC MSVC has banned inline ASM, if we don't care about MSVC then we're free to do other things.  However, you need to do the object thing if you want to use code that accesses simd via intrensics, for something like rdrand or clmul it's no big deal to use asm.
<a name="l-304"></a><span class="tm">19:45:07</span><span class="nk"> &lt;sipa&gt;</span> ok ok
<a name="l-305"></a><span class="tm">19:45:36</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">gmaxwell:</span> yes, intrinsics are more compatible
<a name="l-306"></a><span class="tm">19:45:57</span><span class="nk"> &lt;cfields_&gt;</span> here!
<a name="l-307"></a><span class="tm">19:46:31</span><span class="nk"> &lt;gmaxwell&gt;</span> so we need to fix leveldb to now call into that object without having done the detection. Anything else needed there?
<a name="l-308"></a><span class="tm">19:46:41</span><span class="nk"> &lt;wumpus&gt;</span> I don't think leveldb's way is wrong, except for putting the detection function in the instruction-set specific object
<a name="l-309"></a><span class="tm">19:47:14</span><span class="nk"> &lt;BlueMatt&gt;</span> oh, i was supposed to mention cfields_ would be late
<a name="l-310"></a><span class="tm">19:47:25</span><span class="nk"> &lt;cfields_&gt;</span> heh, thanks
<a name="l-311"></a><span class="tm">19:47:34</span><span class="nk"> &lt;jtimon&gt;</span> maybe we can open an issue on their repo or something?
<a name="l-312"></a><span class="tm">19:47:38</span><span class="nk"> &lt;BlueMatt&gt;</span> you're welcome :)
<a name="l-313"></a><span class="tm">19:47:48</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">jtimon:</span> the issue is in our own build system integration, i'm sure
<a name="l-314"></a><span class="tm">19:47:51</span><span class="nk"> &lt;sipa&gt;</span> not upstream
<a name="l-315"></a><span class="tm">19:48:05</span><span class="nk"> &lt;sipa&gt;</span> oh, you mean for calling the machine specific object? yeah
<a name="l-316"></a><span class="tm">19:48:06</span><span class="nk"> &lt;wumpus&gt;</span> wouldn't upstream have the same problem then?
<a name="l-317"></a><span class="tm">19:48:08</span><span class="nk"> &lt;gmaxwell&gt;</span> jtimon might have been referring to the detection in the wrong object, thats just wrong.
<a name="l-318"></a><span class="tm">19:48:13</span><span class="nk"> &lt;sipa&gt;</span> yeah, agree
<a name="l-319"></a><span class="tm">19:48:18</span><span class="nk"> &lt;sipa&gt;</span> if they ever look at issues...
<a name="l-320"></a><span class="tm">19:48:18</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">gmaxwell:</span> sipa right
<a name="l-321"></a><span class="tm">19:48:21</span><span class="nk"> &lt;gmaxwell&gt;</span> we should submit a fix, it should be trivial.
<a name="l-322"></a><span class="tm">19:48:27</span><span class="nk"> &lt;cfields_&gt;</span> that's done already: https://github.com/theuni/bitcoin/commit/2cb7dda13884e44105f33c16e7e2c1a9aed46295
<a name="l-323"></a><span class="tm">19:48:33</span><span class="nk"> &lt;wumpus&gt;</span> yes better to submit a fix, submitting an issue likely won't help
<a name="l-324"></a><span class="tm">19:48:35</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">cfields_:</span> oh!
<a name="l-325"></a><span class="tm">19:48:36</span><span class="nk"> &lt;cfields_&gt;</span> or are you guys talking about something else?
<a name="l-326"></a><span class="tm">19:48:56</span><span class="nk"> &lt;sipa&gt;</span> probably not
<a name="l-327"></a><span class="tm">19:48:58</span><span class="nk"> &lt;sipa&gt;</span> let's try
<a name="l-328"></a><span class="tm">19:49:09</span><span class="nk"> &lt;gmaxwell&gt;</span> okay, we have actions here.
<a name="l-329"></a><span class="tm">19:49:33</span><span class="nk"> &lt;wumpus&gt;</span> lol &lt;long discussion&gt; oh, cfields did it already
<a name="l-330"></a><span class="tm">19:49:37</span><span class="nk"> &lt;cfields_&gt;</span> that enables the runtime detection and separate object, but iirc there's still a little generic code that may end up with the wrong instructions
<a name="l-331"></a><span class="tm">19:49:45</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">cfields_:</span> yup...
<a name="l-332"></a><span class="tm">19:50:15</span><span class="nk"> &lt;gmaxwell&gt;</span> that just needs to be moved into another file, I expect.
<a name="l-333"></a><span class="tm">19:50:22</span><span class="nk"> &lt;sipa&gt;</span> yup
<a name="l-334"></a><span class="tm">19:50:26</span><span class="nk"> &lt;sipa&gt;</span> let's do that independently
<a name="l-335"></a><span class="tm">19:50:28</span><span class="nk"> &lt;wumpus&gt;</span> yes, move all the code out of it except for the function itself
<a name="l-336"></a><span class="tm">19:50:42</span><span class="nk"> &lt;gmaxwell&gt;</span> should be a trivial patch we can take locally and send upstream.
<a name="l-337"></a><span class="tm">19:50:51</span><span class="nk"> &lt;cfields_&gt;</span> i even linked it on the PR! :)
<a name="l-338"></a><span class="tm">19:50:51</span><span class="nk"> &lt;cfields_&gt;</span> heh, sorry I was late. Movers showed up at 3:00 exactly :\
<a name="l-339"></a><span class="tm">19:51:19</span><span class="nk"> &lt;gmaxwell&gt;</span> We'll need to do the same thing for SSE4 (and sha2 instruction) sha2.
<a name="l-340"></a><span class="tm">19:51:40</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">cfields_:</span> that doesn't seem related the meeting started at 21:00 :p
<a name="l-341"></a><span class="tm">19:51:59</span><span class="nk"> &lt;wumpus&gt;</span> from what I remember that's actual assembly code from intel, in .s format, not using intrinsics
<a name="l-342"></a><span class="tm">19:52:07</span><span class="nk"> &lt;gmaxwell&gt;</span> ah. okay!
<a name="l-343"></a><span class="tm">19:52:18</span><span class="nk"> &lt;luke-jr&gt;</span> <span class="hi">jtimon:</span> 3:00 is meeting time for east USA
<a name="l-344"></a><span class="tm">19:52:29</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">luke-jr:</span> sure, bad joke, sorry
<a name="l-345"></a><span class="tm">19:52:38</span><span class="nk"> &lt;cfields_&gt;</span> i suspect I missed this discussion too, but I have intrinsics done for sha2
<a name="l-346"></a><span class="tm">19:52:43</span><span class="nk"> &lt;gmaxwell&gt;</span> I usually expect corporate code to be intrinsics because having good performance is not enterprise enough. :P
<a name="l-347"></a><span class="tm">19:52:55</span><span class="nk"> &lt;wumpus&gt;</span> https://github.com/laanwj/bitcoin/commit/7e3e717892d96cae7f05dd1b6742425a298cc12e
<a name="l-348"></a><span class="tm">19:53:05</span><span class="nk"> &lt;wumpus&gt;</span> it's even in yasm format
<a name="l-349"></a><span class="tm">19:53:19</span><span class="nk"> &lt;cfields_&gt;</span> <span class="hi">wumpus:</span> ah, i'll shut up :)
<a name="l-350"></a><span class="tm">19:53:36</span><span class="nk"> &lt;gmaxwell&gt;</span> I'm very exicited about getting the faster hash in, with all our other improvements, I'm now expecting a 8% IBD speedup.
<a name="l-351"></a><span class="tm">19:53:46</span><span class="nk"> &lt;gmaxwell&gt;</span> if not more.
<a name="l-352"></a><span class="tm">19:53:55</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">cfields_:</span> you mean sha-specific instructions? the stuff I quote is from before that
<a name="l-353"></a><span class="tm">19:54:12 </span><span class="nka">* jtimon</span> <span class="ac">was used to the other notation and used assemble with nasm, but it's pretty sure we don't want that</span>
<a name="l-354"></a><span class="tm">19:54:15</span><span class="nk"> &lt;cfields_&gt;</span> <span class="hi">wumpus:</span> yea, intrinsics for intel sha1/2
<a name="l-355"></a><span class="tm">19:54:27</span><span class="nk"> &lt;wumpus&gt;</span> it just implements a SHA using SSE4/AVX, so it works on older architectures..
<a name="l-356"></a><span class="tm">19:54:29</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">jtimon:</span> ha, cool
<a name="l-357"></a><span class="tm">19:54:44</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">wumpus:</span> no license issues?
<a name="l-358"></a><span class="tm">19:54:59</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">sipa:</span> not cool, I should have learned with the at &amp; t notation, no?
<a name="l-359"></a><span class="tm">19:55:01</span><span class="nk"> &lt;gmaxwell&gt;</span> <span class="hi">sipa:</span> it's permissively licensed IIRC.
<a name="l-360"></a><span class="tm">19:55:09</span><span class="nk"> &lt;cfields_&gt;</span> <span class="hi">wumpus:</span> ah, nice. I suspect that's where the leveldb discussion came from. We can re-use the build-time logic for sure.
<a name="l-361"></a><span class="tm">19:55:10</span><span class="nk"> &lt;wumpus&gt;</span> <span class="hi">sipa:</span> it's either MIT or BSD
<a name="l-362"></a><span class="tm">19:55:20</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">jtimon:</span> just swap the argument order :)
<a name="l-363"></a><span class="tm">19:55:52</span><span class="nk"> &lt;wumpus&gt;</span> spot-the-license https://github.com/laanwj/bitcoin/blob/7e3e717892d96cae7f05dd1b6742425a298cc12e/src/crypto/sha256_avx1.asm#L10
<a name="l-364"></a><span class="tm">19:55:55</span><span class="nk"> &lt;gmaxwell&gt;</span> Before the metting closes, I'd like to remind people that Matt's caching change #10192 is a 31% block connection speedup.  It's done, rebased current, and needs review.
<a name="l-365"></a><span class="tm">19:55:59</span><span class="nk"> &lt;gribble&gt;</span> https://github.com/bitcoin/bitcoin/issues/10192 | Cache full script execution results in addition to signatures by TheBlueMatt · Pull Request #10192 · bitcoin/bitcoin · GitHub
<a name="l-366"></a><span class="tm">19:56:24</span><span class="nk"> &lt;wumpus&gt;</span> <span class="topic">#topic </span><span class="topicline">cache full script execution</span>
<a name="l-367"></a><span class="tm">19:56:24</span><span class="nk"> &lt;jtimon&gt;</span> <span class="hi">sipa:</span> yeah, I think that's mostly it, and some minor things I think, but I was too lazzy to translate the programs I had
<a name="l-368"></a><span class="tm">19:57:41</span><span class="nk"> &lt;gmaxwell&gt;</span> I don't know that there is too much to say about 10192. It saves a lot of operations when checking if an already validated tx is cached.  It's fairly straight forward.
<a name="l-369"></a><span class="tm">19:58:14</span><span class="nk"> &lt;sipa&gt;</span> yeah, let's do it
<a name="l-370"></a><span class="tm">19:58:28</span><span class="nk"> &lt;wumpus&gt;</span> seems it had a lot of review, no (ut)ACKs though
<a name="l-371"></a><span class="tm">19:58:57</span><span class="nk"> &lt;gmaxwell&gt;</span> I'm working on an ACK now. Just want other people to look, it sat for a long time needing rebase.
<a name="l-372"></a><span class="tm">19:59:16</span><span class="nk"> &lt;wumpus&gt;</span> right
<a name="l-373"></a><span class="tm">19:59:18</span><span class="nk"> &lt;morcos&gt;</span> on the list
<a name="l-374"></a><span class="tm">19:59:20</span><span class="nk"> &lt;sdaftuar&gt;</span> +1
<a name="l-375"></a><span class="tm">19:59:48</span><span class="nk"> &lt;wumpus&gt;</span> it's already on the high priority for review list
<a name="l-376"></a><span class="tm">19:59:57</span><span class="nk"> &lt;gmaxwell&gt;</span> The non-atomic flush stuff is also still outstanding, but I think it might get slightly changed based on todays per txo discussion.
<a name="l-377"></a><span class="tm">19:59:58</span><span class="nk"> &lt;sipa&gt;</span> <span class="hi">cfields_:</span> yours commit (after trivial cherry pick) works
<a name="l-378"></a><span class="tm">20:00:33</span><span class="nk"> &lt;wumpus&gt;</span> <span class="cmd">#endmeeting</span><span class="cmdline"></span></pre>
</body></html>
